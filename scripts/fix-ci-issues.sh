#!/bin/bash

# MPLP CI/CD Issues Fix Script
# ‰øÆÂ§çÊâÄÊúâCI/CDÊ£ÄÊü•Â§±Ë¥•ÁöÑÈóÆÈ¢ò

set -e

echo "üîß MPLP CI/CD Issues Fix Script"
echo "================================"
echo ""

# È¢úËâ≤ÂÆö‰πâ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 1. ‰øÆÂ§çnpmÂÆâÂÖ®ÊºèÊ¥û
echo -e "${YELLOW}1Ô∏è‚É£  Fixing npm security vulnerabilities...${NC}"
echo ""

echo "Current vulnerabilities:"
npm audit --json | node -e "
const data = JSON.parse(require('fs').readFileSync(0, 'utf-8'));
const meta = data.metadata.vulnerabilities;
console.log('  Critical:', meta.critical);
console.log('  High:', meta.high);
console.log('  Moderate:', meta.moderate);
console.log('  Low:', meta.low);
console.log('  Total:', meta.total);
" || true

echo ""
echo "Attempting automatic fix..."
npm audit fix || echo -e "${YELLOW}‚ö†Ô∏è  Some vulnerabilities cannot be auto-fixed${NC}"

echo ""
echo "Attempting force fix (may introduce breaking changes)..."
read -p "Do you want to force fix? (y/N) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]
then
    npm audit fix --force || echo -e "${YELLOW}‚ö†Ô∏è  Force fix completed with warnings${NC}"
fi

# 2. Êõ¥Êñ∞ÊúâÊºèÊ¥ûÁöÑÂåÖ
echo ""
echo -e "${YELLOW}2Ô∏è‚É£  Updating vulnerable packages...${NC}"
echo ""

# Êõ¥Êñ∞validator (moderate vulnerability)
echo "Updating validator..."
npm update validator || true

# Êõ¥Êñ∞express-validator
echo "Updating express-validator..."
npm update express-validator || true

# Êõ¥Êñ∞puppeteerÁõ∏ÂÖ≥ÂåÖ (high vulnerabilities)
echo "Updating puppeteer packages..."
npm update puppeteer puppeteer-core @puppeteer/browsers || true

# 3. Ê£ÄÊü•Mapper validation
echo ""
echo -e "${YELLOW}3Ô∏è‚É£  Checking Mapper validation...${NC}"
echo ""

if npm run validate:mapping; then
    echo -e "${GREEN}‚úÖ Mapper validation passed${NC}"
else
    echo -e "${RED}‚ùå Mapper validation failed${NC}"
    echo "This may require manual investigation"
fi

# 4. ËøêË°åÂÆåÊï¥ÊµãËØï
echo ""
echo -e "${YELLOW}4Ô∏è‚É£  Running full test suite...${NC}"
echo ""

if npm test; then
    echo -e "${GREEN}‚úÖ All tests passed${NC}"
else
    echo -e "${RED}‚ùå Some tests failed${NC}"
    echo "Please review test failures"
fi

# 5. ÊúÄÁªàÂÆâÂÖ®ÂÆ°ËÆ°Êä•Âëä
echo ""
echo -e "${YELLOW}5Ô∏è‚É£  Final security audit report...${NC}"
echo ""

npm audit --json | node -e "
const data = JSON.parse(require('fs').readFileSync(0, 'utf-8'));
const meta = data.metadata.vulnerabilities;
console.log('Final vulnerability count:');
console.log('  Critical:', meta.critical);
console.log('  High:', meta.high);
console.log('  Moderate:', meta.moderate);
console.log('  Low:', meta.low);
console.log('  Total:', meta.total);

if (meta.critical > 0 || meta.high > 0) {
    console.log('');
    console.log('‚ö†Ô∏è  WARNING: Critical or High vulnerabilities still exist!');
    console.log('Please review manually:');
    console.log('  npm audit');
    process.exit(1);
} else if (meta.moderate > 0) {
    console.log('');
    console.log('‚ö†Ô∏è  Moderate vulnerabilities exist but may be acceptable');
    process.exit(0);
} else {
    console.log('');
    console.log('‚úÖ No critical or high vulnerabilities!');
    process.exit(0);
}
" || true

echo ""
echo -e "${GREEN}================================${NC}"
echo -e "${GREEN}CI/CD Fix Script Completed!${NC}"
echo -e "${GREEN}================================${NC}"

