# MPLP v1.0 开发规范文档

> **文档版本**: v2.0.0  
> **更新时间**: 2025-07-10T13:28:12+08:00  
> **项目**: Multi-Agent Project Lifecycle Protocol (MPLP) v1.0  
> **状态**: 最新版本

## 📋 概述

本文档定义了MPLP项目的完整开发规范，包括**Schema驱动开发原则**、代码标准、测试要求和质量控制流程。

## 🎯 核心开发原则

### 1. Schema驱动开发原则（最高优先级）🆕

#### Schema为绝对核心
- **唯一标准**: `src/schemas/`目录下的JSON Schema是所有开发的权威来源
- **字段匹配**: 所有代码中的字段名称、类型结构、枚举值必须100%匹配Schema定义
- **优先级**: Schema定义优先级高于任何现有代码、文档或约定

#### 强制开发流程
```
1. 📖 读取Schema定义 → 确认数据模型
2. 🔍 评估现有代码 → 识别Schema差异
3. 🏗️ 按序开发 → Schema → Types → Modules → Services → Tests
4. ✅ 验证合规性 → 确保100%Schema匹配
```

#### 严格禁止行为
- ❌ 未读取Schema即开始开发
- ❌ 使用与Schema不符的字段名称（如`planId`而非`plan_id`）
- ❌ 偏离Schema定义的类型结构
- ❌ 在Schema未确认前编写测试用例

#### Schema验证要求
- 所有接口必须通过Schema验证工具检查
- 测试用例必须验证Schema合规性
- API响应格式必须符合Schema定义

### 2. Plan→Confirm→Trace→Delivery流程

每个开发任务必须严格遵循四阶段流程，其中**每个阶段都必须确保Schema合规性**：

#### Plan阶段增强 🆕
- **Schema分析**: 详细分析相关Schema文件的完整结构
- **合规规划**: 制定Schema合规的技术实现方案
- **字段映射**: 明确所有字段与Schema的对应关系

#### Confirm阶段增强 🆕
- **Schema确认**: 确认技术方案完全符合Schema定义
- **类型验证**: 确认类型定义与Schema结构一致
- **枚举检查**: 确认枚举值与Schema规范完全匹配

#### Trace阶段增强 🆕
- **实时验证**: 开发过程中持续验证Schema合规性
- **自动检查**: 使用Schema验证工具自动检查
- **偏差纠正**: 发现Schema偏差立即纠正

#### Delivery阶段增强 🆕
- **Schema测试**: 完整的Schema合规性测试套件
- **验证报告**: 提供Schema验证通过的证明
- **合规确认**: 最终确认所有交付物符合Schema

## 🔧 技术实现规范

### Schema验证工具集成
```typescript
// 示例：Plan模块Schema验证
import { SchemaValidator } from '../core/schema-validator';
import planSchema from '../schemas/plan-protocol.json';

export class PlanService {
  private validator = new SchemaValidator(planSchema);

  public async createPlan(data: any): Promise<PlanProtocol> {
    // 1. Schema验证
    if (!this.validator.validate(data)) {
      throw new ValidationError('数据不符合Plan Schema定义');
    }

    // 2. 确保返回值也符合Schema
    const plan: PlanProtocol = {
      plan_id: generateUUID(),
      context_id: data.context_id,
      protocol_version: '1.0.0',
      timestamp: new Date().toISOString(),
      name: data.name,
      tasks: data.tasks || [],
      configuration: data.configuration
    };

    return plan;
  }
}
```

### 类型定义规范 🆕
```typescript
// src/modules/plan/types.ts - 完全基于Schema
export interface PlanProtocol {
  // 所有字段名称必须与plan-protocol.json完全一致
  plan_id: UUID;                    // Schema: plan_id
  context_id: UUID;                 // Schema: context_id
  protocol_version: Version;        // Schema: protocol_version
  timestamp: Timestamp;             // Schema: timestamp
  name: string;                     // Schema: name
  description?: string;             // Schema: description (可选)
  tasks: TaskDefinition[];          // Schema: tasks
  configuration: PlanConfiguration; // Schema: configuration
}

// 枚举必须与Schema完全匹配
export enum ExecutionStrategy {
  SEQUENTIAL = 'sequential',        // Schema: sequential
  PARALLEL = 'parallel',            // Schema: parallel
  CONDITIONAL = 'conditional'       // Schema: conditional
}
```

## 📊 质量控制

### Schema合规性检查清单 🆕
开发前：
- [ ] 已读取相关Schema JSON文件
- [ ] 确认字段名称与Schema匹配
- [ ] 确认类型结构与Schema对应
- [ ] 确认枚举值与Schema一致

开发中：
- [ ] 实时使用Schema验证工具
- [ ] TypeScript类型定义符合Schema
- [ ] 测试数据符合Schema规范
- [ ] API接口遵循Schema格式

开发后：
- [ ] 通过自动Schema验证
- [ ] 所有测试验证Schema合规性
- [ ] 文档示例数据符合Schema
- [ ] 交付物100%Schema兼容

### 自动化检查流程
```bash
# Schema验证命令
npm run schema:validate     # 验证代码与Schema匹配
npm run schema:test        # 运行Schema合规性测试
npm run schema:coverage    # Schema覆盖率报告
```

## 📚 开发工具和环境

### Schema开发工具 🆕
- **Schema验证器**: Ajv JSON Schema validator
- **类型生成器**: JSON Schema to TypeScript
- **VS Code插件**: JSON Schema validator
- **测试框架**: Schema-based test data generation

### 集成开发环境配置
```json
// .vscode/settings.json
{
  "json.schemas": [
    {
      "fileMatch": ["**/schemas/*.json"],
      "url": "https://json-schema.org/draft/2020-12/schema"
    }
  ],
  "typescript.preferences.includePackageJsonAutoImports": "on"
}
```

## ✅ 总结

Schema驱动开发原则的引入确保了MPLP项目的：
1. **一致性** - 所有模块字段名称和类型完全一致
2. **可维护性** - Schema变更能系统性地推动代码更新
3. **质量保证** - 自动化验证确保实现与规范匹配
4. **开发效率** - 明确的Schema指导减少重构和调试时间

所有开发者必须严格遵循此规范，任何偏离Schema的代码都不会被接受。

---

**文档维护**: 随Schema变更同步更新  
**执行监督**: AI助手和代码审查强制检查  
**违规处理**: 不符合Schema的代码必须重新开发