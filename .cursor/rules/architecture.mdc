description: "MPLP项目系统架构设计原则，定义6个核心模块架构和技术栈规范"
globs: ["src/**/*.ts", "**/*-service.ts", "**/*-controller.ts", "**/*-manager.ts", "**/architecture/**/*"]
alwaysApply: true
---

# MPLP 1.0 架构设计规则

> **规则版本**: v2.3  
> **更新时间**: 2025-07-15T10:30:00+08:00  
> **适用项目**: Multi-Agent Project Lifecycle Protocol (MPLP) v1.0  
> **关联文档**: [技术设计文档](../../requirements-docs/01_技术设计文档.md) | [MPLP协议开发专项路线图](../../requirements-docs/mplp_protocol_roadmap.md)  
> **协议版本**: v1.0.1 (基于Roadmap v1.0架构规范，增加failure_resolver功能)

## 🏗️ 核心架构原则（基于Roadmap v1.0）

### 架构理念
- **模块化设计**: 6个核心模块独立且协作
- **厂商中立**: 协议完全中立，支持任何平台集成，避免供应商锁定
- **开放标准**: 提供通用接口，允许任何第三方工具和平台集成
- **可扩展性**: Extension模块支持插件式扩展
- **高性能**: API响应P95<100ms，协议解析<10ms
- **高可用**: 系统可用性≥99.9%，支持1000+并发

### 厂商中立原则（最高架构优先级）
```
MPLP协议是一个完全厂商中立的开放标准，不依赖于任何特定厂商或平台。
所有核心功能必须独立于任何特定第三方工具或服务实现。
TracePilot和Coregentis仅作为集成示例，展示如何与MPLP协议集成。
任何厂商特定的适配器或集成必须通过Extension模块实现，不得侵入核心代码。
```

### 厂商中立接口设计规范
```typescript
// 厂商中立接口设计关键规则

// 1. 通用接口命名必须中立
interface ITraceAdapter {  // 使用I前缀 + PascalCase，不包含厂商名称
  syncTraceData(data: TraceData): Promise<SyncResult>;
  checkHealth(): Promise<AdapterHealth>;
}

// 2. 核心模块只能依赖中立接口，不能直接引用厂商实现
class PlanManager {
  private traceAdapter: ITraceAdapter; // ✅ 正确：依赖通用接口
  
  setTraceAdapter(adapter: ITraceAdapter): void { // ✅ 正确：参数类型为通用接口
    this.traceAdapter = adapter;
  }
}

// 3. 厂商特定实现必须实现中立接口
class TracePilotAdapter implements ITraceAdapter { // ✅ 正确：实现通用接口
  syncTraceData(data: TraceData): Promise<SyncResult> {
    // 厂商特定实现
  }
}

// 4. 适配器实现应放在独立的集成目录中
// src/adapters/trace/base-trace-adapter.ts    // ✅ 正确：基础适配器
// src/adapters/trace/enhanced-trace-adapter.ts // ✅ 正确：增强适配器
// src/modules/plan/tracepilot.ts   // ❌ 错误：不应放在核心模块中
```

### 技术架构栈（匹配Roadmap技术栈）
```
┌─────────────────── 表示层 ───────────────────┐
│ REST API + GraphQL + WebSocket实时通信       │
├─────────────────── 应用层 ───────────────────┤
│ Express.js 4.18+ + Helmet.js安全中间件      │
├─────────────────── 业务层 ───────────────────┤
│ 6个核心模块: Context/Plan/Confirm/Trace/   │
│ Role/Extension + TypeScript 5.0+严格模式   │
├─────────────────── 持久层 ───────────────────┤
│ PostgreSQL 14+ + TypeORM + Redis 7+缓存    │
├─────────────────── 基础层 ───────────────────┤
│ Node.js 18+ LTS + Docker + Kubernetes      │
└─────────────────────────────────────────────┘
```

## 📋 6个核心模块架构（基于MPLP v1.0.1协议）

### Context模块 - 全局状态管理
```typescript
// 架构层次
Context Service ──→ Context Repository ──→ PostgreSQL
     ↓                    ↓                    ↓
Context Cache ────→ Redis Cache ──────→ 状态同步
     ↓
WebSocket ────────→ 实时状态推送
```

**设计原则**:
- 状态查询<5ms，状态更新<10ms
- 支持跨系统状态同步
- 实时状态变更通知
- 会话生命周期管理

### Plan模块 - 任务规划结构
```typescript
// 任务编排架构
Plan Engine ──→ Task Scheduler ──→ Dependency Resolver
     ↓               ↓                    ↓
Execution Manager ←─ Task Queue ←──── Parallel Executor
     ↓
Progress Tracker ──→ Trace模块 ──→ 执行监控
     ↓
Failure Resolver ──→ 故障处理 ──→ 自动恢复
```

**设计原则**:
- 计划解析<8ms，执行调度<15ms
- 支持串行/并行/条件执行
- 动态依赖关系解析
- 失败重试和补偿机制
- **failure_resolver智能故障处理** (v1.0.1新增)

### Confirm模块 - 验证决策机制
```typescript
// 审批流程架构
Approval Engine ──→ Rule Engine ──→ Decision Tree
     ↓                  ↓               ↓
Auto Approval ←─── Condition Matcher ←─ Policy Store
     ↓
Notification Hub ──→ 审批通知 ──→ 实时提醒
```

**设计原则**:
- 审批检查<3ms，决策执行<12ms
- 灵活的审批规则配置
- 自动审批条件支持
- 完整的审批轨迹记录

### Trace模块 - 追踪记录信息
```typescript
// 追踪监控架构
Trace Collector ──→ Performance Monitor ──→ Metrics Store
     ↓                    ↓                     ↓
Event Stream ────→ Real-time Analytics ←─── Alert Manager
     ↓
Compensation Engine ──→ 错误恢复 ──→ 自动修复
```

**设计原则**:
- 追踪记录<2ms，查询分析<20ms
- 分布式链路追踪支持
- 实时性能监控和告警
- 自动补偿和错误恢复

### Role模块 - 角色定义能力
```typescript
// 权限管理架构
RBAC Engine ──→ Permission Cache ──→ Access Control
     ↓               ↓                   ↓
Role Inheritance ←─ Capability Store ←─ Policy Engine
     ↓
Dynamic Assignment ──→ 权限热更新 ──→ 即时生效
```

**设计原则**:
- 权限检查<1ms，角色解析<5ms
- 细粒度权限控制
- 动态角色继承支持
- 实时权限变更生效

### Extension模块 - 扩展机制框架
```typescript
// 扩展生态架构
Extension Registry ──→ Lifecycle Manager ──→ Health Monitor
     ↓                     ↓                    ↓
Plugin Loader ────→ Capability Publisher ←─── Service Discovery
     ↓
Integration Hub ──→ 平台适配器 ──→ TracePilot + Coregentis
```

**设计原则**:
- 扩展调用<50ms，健康检查<10ms
- 标准化扩展接口
- 热插拔和版本管理
- 跨平台集成支持

## 🔗 适配器架构设计

### 适配器层次结构
```
接口层: ITraceAdapter, IPlanAdapter, IConfirmAdapter, ...
    ↑
基础实现层: BaseTraceAdapter, BasePlanAdapter, ...
    ↑
增强实现层: EnhancedTraceAdapter, EnhancedPlanAdapter, ...
    ↑
厂商实现层: 具体厂商适配器实现
```

### 适配器设计原则
1. **接口中立性**: 通用接口不包含厂商特定术语
2. **依赖注入**: 使用依赖注入而非直接实例化
3. **可替换性**: 支持运行时替换适配器实现
4. **错误隔离**: 适配器错误不应传播到核心模块
5. **性能缓冲**: 实现本地缓存减少外部依赖
6. **优雅降级**: 外部服务不可用时提供降级策略
7. **版本兼容**: 处理不同版本API的兼容性

### 适配器工厂模式
```typescript
// 适配器工厂 - 创建适配器实例
class TraceAdapterFactory {
  // 创建基础适配器
  static createBaseAdapter(config: AdapterConfig): ITraceAdapter {
    return new BaseTraceAdapter(config);
  }
  
  // 创建增强适配器
  static createEnhancedAdapter(config: AdapterConfig): ITraceAdapter {
    return new EnhancedTraceAdapter(config);
  }
  
  // 根据配置创建适配器
  static createAdapter(config: AdapterConfig): ITraceAdapter {
    if (config.useEnhanced) {
      return this.createEnhancedAdapter(config);
    }
    return this.createBaseAdapter(config);
  }
}
```

### 适配器目录结构
```
src/
  interfaces/           # 通用接口定义
    trace-adapter.interface.ts
    plan-adapter.interface.ts
    ...
  adapters/             # 适配器基础实现
    trace/
      base-trace-adapter.ts
      enhanced-trace-adapter.ts
      adapter-factory.ts
    plan/
      ...
  mcp/                  # 厂商特定实现
    tracepilot-adapter.ts
    enhanced-tracepilot-adapter.ts
    ...
```

## 🔄 第三方集成架构（参考实现示例）

MPLP协议设计为可与任何第三方平台和工具集成。以下示例展示如何通过标准适配器模式实现集成：

### 参考示例1: TracePilot集成
```typescript
// TracePilot适配器架构（参考实现）
MPLP Core ──→ 标准适配器接口 ──→ TracePilot适配器实现
     ↓              ↓                     ↓
Trace Data ──→ 数据格式转换器 ──→ 第三方API调用
     ↓
标准事件系统 ──→ 事件订阅机制 ──→ 双向数据同步
```

### 参考示例2: Coregentis集成
```typescript
// Coregentis集成架构（参考实现）
MPLP Protocol ──→ 标准扩展接口 ──→ Coregentis适配器
     ↓                  ↓                    ↓
标准业务逻辑 ──→ 扩展点实现 ──→ 第三方服务调用
     ↓
标准事件总线 ──→ 事件处理器 ──→ 外部系统通知
```

### 通用集成原则
- **标准接口**: 所有集成必须通过标准化接口实现
- **松耦合**: 核心功能不得依赖任何特定第三方实现
- **可替换性**: 任何集成实现都可以被其他实现替换
- **隔离性**: 第三方集成故障不应影响核心功能
- **性能约束**: 集成实现必须满足MPLP性能标准

## 🔧 技术实现架构

### 数据架构
```typescript
// 数据层设计
┌─── PostgreSQL 14+ (主数据库) ───┐
│ - Context状态数据              │
│ - Plan任务计划                │
│ - Confirm审批记录             │
│ - Role权限数据                │
└─────────────────────────────┘
         ↕
┌─── Redis 7+ (缓存层) ──────┐
│ - 热点数据缓存             │
│ - 会话状态缓存             │
│ - 权限缓存                │
│ - 临时数据存储             │
└─────────────────────────┘
```

### API架构层次
```typescript
// API服务架构
┌─── REST API (Express.js) ───┐
│ - CRUD操作                 │
│ - 资源管理                 │
│ - 状态查询                 │
└─────────────────────────┘
         ↕
┌─── GraphQL Schema ─────┐
│ - 复杂查询            │
│ - 关联数据获取        │
│ - 实时订阅            │
└─────────────────────┘
         ↕
┌─── WebSocket ──────────┐
│ - 实时通信            │
│ - 状态推送            │
│ - 事件通知            │
└─────────────────────┘
```

## 📊 性能架构设计（基于Roadmap性能要求）

### 性能优化策略
```typescript
// 性能优化架构
┌─── 应用层优化 ───┐    ┌─── 数据层优化 ───┐
│ - 连接池复用    │    │ - 索引优化      │
│ - 缓存策略      │    │ - 查询优化      │
│ - 异步处理      │    │ - 分片策略      │
└───────────────┘    └───────────────┘
         ↕                     ↕
┌─── 网络层优化 ───┐    ┌─── 系统层优化 ───┐
│ - CDN加速       │    │ - 负载均衡      │
│ - 压缩传输      │    │ - 容器优化      │
│ - HTTP/2支持    │    │ - 资源调度      │
└───────────────┘    └───────────────┘
```

### 监控架构
```typescript
// 监控体系架构
┌─── 业务监控 ───┐    ┌─── 性能监控 ───┐
│ - 协议调用量  │    │ - 响应时间     │
│ - 成功率统计  │    │ - 吞吐量       │
│ - 错误率分析  │    │ - 资源利用率   │
└─────────────┘    └─────────────┘
         ↕                   ↕
┌─── 安全监控 ───┐    ┌─── 系统监控 ───┐
│ - 访问控制    │    │ - 服务状态     │
│ - 异常检测    │    │ - 健康检查     │
│ - 审计日志    │    │ - 容量规划     │
└─────────────┘    └─────────────┘
```

## 🛡️ 安全架构设计

### 安全防护层次
```typescript
// 安全架构分层
┌─── 网络安全层 ───┐
│ - TLS 1.3加密   │
│ - WAF防护       │
│ - DDoS防护      │
└─────────────────┘
         ↓
┌─── 应用安全层 ───┐
│ - JWT认证       │
│ - RBAC权限      │
│ - Rate Limiting │
└─────────────────┘
         ↓
┌─── 数据安全层 ───┐
│ - AES-256加密   │
│ - 数据脱敏      │
│ - 备份加密      │
└─────────────────┘
```

## 🚀 部署架构（基于Roadmap部署规划）

### 容器化架构
```yaml
# Kubernetes部署架构
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mplp-core
spec:
  replicas: 3
  template:
    spec:
      containers:
      - name: mplp-api
        image: mplp:v1.0.1
        resources:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
```

### 微服务架构演进
```typescript
// 未来架构演进方向
┌─── 当前单体架构 (v1.0) ───┐
│ MPLP Core Application    │
│ - 6个核心模块集成        │
│ - 单一部署单元           │
└─────────────────────────┘
         ↓ (演进路径)
┌─── 微服务架构 (v2.0+) ───┐
│ Context Service         │
│ Plan Service           │
│ Confirm Service        │
│ Trace Service          │
│ Role Service           │
│ Extension Service      │
└─────────────────────────┘
```

---

**架构规则版本**: v2.3  
**维护团队**: MPLP架构团队  
**审查周期**: 每个开发阶段结束后审查  
**技术支持**: architecture@mplp.dev

description: "MPLP系统架构设计规则 - 定义系统架构原则、模块设计规范和技术实现指导"
globs: ["**/*.ts", "**/*.js", "**/architecture/**", "**/design/**", "**/modules/**"]
alwaysApply: true
---
 