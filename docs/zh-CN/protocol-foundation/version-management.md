# MPLP版本管理

**协议版本管理和兼容性策略**

[![语义化版本](https://img.shields.io/badge/versioning-Semantic-blue.svg)](https://semver.org/)
[![兼容性](https://img.shields.io/badge/compatibility-Backward%20Compatible-green.svg)](./interoperability.md)
[![迁移](https://img.shields.io/badge/migration-Automated-brightgreen.svg)](./implementation-guide.md)
[![语言](https://img.shields.io/badge/language-简体中文-red.svg)](../../en/protocol-foundation/version-management.md)

---

## 1. 版本策略

### 1.1 **语义化版本**

MPLP遵循语义化版本2.0.0规范，并包含协议特定的扩展。

**版本格式**：`MAJOR.MINOR.PATCH[-PRERELEASE][+BUILD]`

```
示例：
- 1.0.0-alpha     (Alpha版本)
- 1.0.0-beta.1    (Beta版本)
- 1.0.0-rc.2      (候选版本)
- 1.0.0           (稳定版本)
- 1.1.0           (次要更新)
- 1.0.1           (补丁更新)
- 2.0.0           (主要更新)
```

### 1.2 **版本组件**

#### **主版本（MAJOR）**
当协议发生不兼容更改，破坏向后兼容性时递增。

**触发条件**：
- 消息格式的破坏性更改
- 移除必需字段或操作
- 核心协议语义的更改
- 主要架构重构

#### **次版本（MINOR）**
当添加向后兼容的功能时递增。

**触发条件**：
- Schema中的新可选字段
- 额外的操作或端点
- 新的协调模块
- 性能改进

#### **补丁版本（PATCH）**
当进行向后兼容的错误修复和安全更新时递增。

**触发条件**：
- 不涉及API更改的错误修复
- 安全漏洞补丁
- 文档更正
- 内部优化

---

## 2. 预发布版本

### 2.1 **Alpha版本**
**目的**：用于内部测试和反馈的早期开发版本
**稳定性**：不稳定，API可能频繁更改
**受众**：开发者、早期采用者、测试人员

```
格式：X.Y.Z-alpha[.N]
示例：1.0.0-alpha, 1.0.0-alpha.1, 1.0.0-alpha.2
```

### 2.2 **Beta版本**
**目的**：功能完整的版本，用于更广泛的测试
**稳定性**：基本稳定，可能有小的API更改
**受众**：Beta测试人员、集成合作伙伴

```
格式：X.Y.Z-beta[.N]
示例：1.0.0-beta, 1.0.0-beta.1, 1.0.0-beta.2
```

### 2.3 **候选版本（RC）**
**目的**：稳定版本发布前的最终测试
**稳定性**：稳定，仅进行关键错误修复
**受众**：生产环境评估者、最终测试人员

```
格式：X.Y.Z-rc[.N]
示例：1.0.0-rc, 1.0.0-rc.1, 1.0.0-rc.2
```

---

## 3. 兼容性矩阵

### 3.1 **协议兼容性**

| 客户端版本 | 服务端版本 | 兼容性 | 说明 |
|-----------|-----------|--------|------|
| 1.0.x | 1.0.x | ✅ 完全兼容 | 相同的主.次版本 |
| 1.0.x | 1.1.x | ✅ 完全兼容 | 向后兼容 |
| 1.1.x | 1.0.x | ⚠️ 有限兼容 | 向前兼容 |
| 1.x.x | 2.x.x | ❌ 不兼容 | 主版本差异 |

### 3.2 **模块兼容性**

每个模块在整体协议版本内维护自己的兼容性矩阵。

```json
{
  "protocol_version": "1.0.0-alpha",
  "module_versions": {
    "context": "1.0.0-alpha",
    "plan": "1.0.0-alpha",
    "role": "1.0.0-alpha",
    "confirm": "1.0.0-alpha",
    "trace": "1.0.0-alpha",
    "extension": "1.0.0-alpha",
    "dialog": "1.0.0-alpha",
    "collab": "1.0.0-alpha",
    "network": "1.0.0-alpha",
    "core": "1.0.0-alpha"
  }
}
```

---

## 4. 版本协商

### 4.1 **协议握手**

所有MPLP通信都以版本协商握手开始。

```json
{
  "message_type": "version_negotiation",
  "supported_versions": ["1.0.0-alpha", "0.9.0"],
  "preferred_version": "1.0.0-alpha",
  "client_capabilities": {
    "modules": ["context", "plan", "role"],
    "features": ["encryption", "compression"]
  }
}
```

### 4.2 **版本选择算法**

1. **精确匹配**：如果双方都支持，使用精确版本
2. **向后兼容**：使用最高兼容版本
3. **功能协商**：协商可用功能
4. **回退**：使用最低支持版本或失败

---

## 5. 迁移策略

### 5.1 **自动迁移**

MPLP提供版本升级的自动迁移工具。

```bash
# 迁移命令示例
mplp migrate --from 1.0.0-alpha --to 1.1.0 --config migration.json

# 验证命令
mplp validate-migration --source-version 1.0.0-alpha --target-version 1.1.0
```

### 5.2 **迁移类型**

#### **Schema迁移**
- 字段添加（向后兼容）
- 字段弃用（带警告）
- 类型更改（带转换）
- 结构重组

#### **API迁移**
- 端点添加
- 参数更改
- 响应格式更新
- 弃用通知

#### **数据迁移**
- 状态格式转换
- 配置更新
- 持久数据转换
- 索引重建

### 5.3 **迁移阶段**

```
阶段1：准备
├── 备份当前状态
├── 验证迁移路径
└── 准备回滚计划

阶段2：迁移
├── 停止活动操作
├── 转换数据结构
├── 更新配置
└── 重启服务

阶段3：验证
├── 运行兼容性测试
├── 验证数据完整性
├── 检查性能指标
└── 确认功能

阶段4：清理
├── 移除弃用代码
├── 更新文档
├── 清理临时文件
└── 归档旧版本
```

---

## 6. 弃用政策

### 6.1 **弃用时间线**

功能按照结构化时间线进行弃用，以确保平稳过渡。

```
公告 → 警告期 → 弃用 → 移除
  ↓      ↓      ↓     ↓
版本N  版本N+1  版本N+2  版本N+3
(6个月) (6个月)  (6个月)  (最终)
```

### 6.2 **弃用级别**

#### **级别1：软弃用**
- 功能仍正常工作
- 文档标记为弃用
- 提供替代解决方案
- 无破坏性更改

#### **级别2：硬弃用**
- 功能生成警告
- 性能可能降低
- 提供有限支持
- 需要迁移路径

#### **级别3：移除**
- 功能不再可用
- 使用时生成错误
- 强制迁移
- 无向后兼容性

---

## 7. 版本支持政策

### 7.1 **支持生命周期**

| 版本类型 | 支持持续时间 | 更新 | 生命周期结束 |
|---------|-------------|------|-------------|
| **Alpha** | 6个月 | 仅错误修复 | 下一个alpha |
| **Beta** | 12个月 | 错误修复+安全 | 下一个beta |
| **稳定版** | 24个月 | 完全支持 | 已公告 |
| **LTS** | 36个月 | 安全+关键 | 已计划 |

### 7.2 **支持类别**

#### **完全支持**
- 新功能和增强
- 错误修复和优化
- 安全更新
- 文档更新
- 社区支持

#### **维护支持**
- 仅关键错误修复
- 安全漏洞补丁
- 无新功能
- 有限的文档更新

#### **安全支持**
- 仅安全补丁
- 关键漏洞修复
- 无功能更新
- 非安全问题不修复

---

## 8. 版本检测

### 8.1 **运行时版本检查**

```typescript
// 版本检测API
interface VersionInfo {
  protocol_version: string;
  module_versions: Record<string, string>;
  supported_features: string[];
  compatibility_level: 'full' | 'partial' | 'none';
}

// 使用示例
const versionInfo = await mplp.getVersionInfo();
if (versionInfo.compatibility_level !== 'full') {
  console.warn('检测到版本兼容性问题');
}
```

### 8.2 **版本验证**

```bash
# CLI版本验证
mplp version check --target 1.1.0
mplp version compatibility --client 1.0.0 --server 1.1.0
mplp version features --version 1.0.0-alpha
```

---

## 9. 发布流程

### 9.1 **发布阶段**

```
开发 → 测试 → 预发布 → 生产
  ↓     ↓      ↓       ↓
Alpha  Beta    RC    稳定版
```

### 9.2 **发布检查清单**

#### **预发布**
- [ ] 所有测试通过（100%）
- [ ] 文档已更新
- [ ] 迁移脚本已测试
- [ ] 性能基准达标
- [ ] 安全扫描完成

#### **发布**
- [ ] 版本标签已创建
- [ ] 发布说明已发布
- [ ] 包已分发
- [ ] 文档已部署
- [ ] 社区已通知

#### **发布后**
- [ ] 监控系统健康
- [ ] 收集用户反馈
- [ ] 跟踪采用指标
- [ ] 规划下一次迭代
- [ ] 更新路线图

---

## 10. 版本历史

### 10.1 **当前版本**

| 版本 | 发布日期 | 状态 | 说明 |
|------|---------|------|------|
| 1.0.0-alpha | 2025-09-03 | 当前 | 初始Alpha版本 |

### 10.2 **计划版本**

| 版本 | 目标日期 | 功能 | 状态 |
|------|---------|------|------|
| 1.0.0-beta | 2025-12-01 | API稳定化 | 计划中 |
| 1.0.0-rc | 2026-02-01 | 最终测试 | 计划中 |
| 1.0.0 | 2026-03-01 | 稳定版本 | 计划中 |

---

**文档版本**：1.0  
**最后更新**：2025年9月3日  
**下次审查**：2025年12月3日  
**批准**：协议指导委员会  
**语言**：简体中文

**⚠️ Alpha版本说明**：版本管理政策可能会根据Alpha版本反馈和社区意见进行完善。
