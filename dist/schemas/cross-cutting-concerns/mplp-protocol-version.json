{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "https://mplp.dev/schemas/v1.0/mplp-protocol-version.json",
    "title": "MPLP Protocol Version Management v1.0",
    "description": "多智能体协议生命周期平台协议版本管理和兼容性Schema",
    "type": "object",
    "$defs": {
        "uuid": {
            "type": "string",
            "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$",
            "description": "UUID v4 format"
        },
        "timestamp": {
            "type": "string",
            "format": "date-time",
            "description": "ISO 8601 timestamp"
        },
        "version": {
            "type": "string",
            "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-((?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\\.(?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\\+([0-9a-zA-Z-]+(?:\\.[0-9a-zA-Z-]+)*))?$",
            "description": "语义化版本号 (SemVer)"
        },
        "compatibility_level": {
            "type": "string",
            "enum": ["breaking", "compatible", "deprecated", "experimental"],
            "description": "兼容性级别"
        },
        "module_version_info": {
            "type": "object",
            "properties": {
                "module_name": {
                    "type": "string",
                    "enum": ["core", "context", "plan", "confirm", "trace", "role", "extension", "collab", "dialog", "network", "coordination", "orchestration", "transaction", "event_bus", "state_sync"],
                    "description": "模块名称"
                },
                "current_version": { "$ref": "#/$defs/version" },
                "supported_versions": {
                    "type": "array",
                    "items": { "$ref": "#/$defs/version" },
                    "description": "支持的版本列表"
                },
                "deprecated_versions": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "version": { "$ref": "#/$defs/version" },
                            "deprecation_date": { "$ref": "#/$defs/timestamp" },
                            "removal_date": { "$ref": "#/$defs/timestamp" },
                            "migration_guide": {
                                "type": "string",
                                "description": "迁移指南URL或说明"
                            },
                            "protocol_version_operation": {
                                "type": "string",
                                "enum": [
                                    "create",
                                    "update",
                                    "activate",
                                    "deprecate",
                                    "migrate"
                                ]
                            },
                            "protocol_version_details": {
                                "type": "object",
                                "properties": {
                                    "compatibility_mode": {
                                        "type": "string",
                                        "enum": [
                                            "strict",
                                            "backward",
                                            "forward",
                                            "full"
                                        ]
                                    },
                                    "migration_strategy": {
                                        "type": "string"
                                    },
                                    "rollback_support": {
                                        "type": "boolean"
                                    }
                                }
                            }
                        },
                        "required": ["version", "deprecation_date"]
                    }
                },
                "breaking_changes": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "version": { "$ref": "#/$defs/version" },
                            "change_description": { "type": "string" },
                            "impact_level": {
                                "type": "string",
                                "enum": ["low", "medium", "high", "critical"]
                            },
                            "migration_required": { "type": "boolean" },
                            "affected_apis": {
                                "type": "array",
                                "items": { "type": "string" }
                            }
                        },
                        "required": ["version", "change_description", "impact_level"]
                    }
                }
            },
            "required": ["module_name", "current_version", "supported_versions"]
        },
        "compatibility_matrix": {
            "type": "object",
            "properties": {
                "matrix_version": { "$ref": "#/$defs/version" },
                "compatibility_rules": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "source_module": { "type": "string" },
                            "source_version": { "$ref": "#/$defs/version" },
                            "target_module": { "type": "string" },
                            "target_version_range": {
                                "type": "string",
                                "description": "支持的目标版本范围，使用semver范围语法"
                            },
                            "compatibility_level": { "$ref": "#/$defs/compatibility_level" },
                            "notes": { "type": "string" }
                        },
                        "required": ["source_module", "source_version", "target_module", "target_version_range", "compatibility_level"]
                    }
                },
                "global_constraints": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "constraint_type": {
                                "type": "string",
                                "enum": ["minimum_version", "maximum_version", "exact_version", "exclude_version"]
                            },
                            "modules": {
                                "type": "array",
                                "items": { "type": "string" }
                            },
                            "version_constraint": { "type": "string" },
                            "reason": { "type": "string" }
                        },
                        "required": ["constraint_type", "modules", "version_constraint"]
                    }
                }
            },
            "required": ["matrix_version", "compatibility_rules"]
        },
        "upgrade_path": {
            "type": "object",
            "properties": {
                "path_id": { "$ref": "#/$defs/uuid" },
                "from_version": { "$ref": "#/$defs/version" },
                "to_version": { "$ref": "#/$defs/version" },
                "upgrade_steps": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "step_number": { "type": "integer", "minimum": 1 },
                            "step_description": { "type": "string" },
                            "step_type": {
                                "type": "string",
                                "enum": ["schema_update", "data_migration", "api_change", "configuration_change", "validation"]
                            },
                            "affected_modules": {
                                "type": "array",
                                "items": { "type": "string" }
                            },
                            "automation_script": {
                                "type": "string",
                                "description": "自动化脚本路径或命令"
                            },
                            "manual_steps": {
                                "type": "array",
                                "items": { "type": "string" }
                            },
                            "validation_criteria": {
                                "type": "array",
                                "items": { "type": "string" }
                            },
                            "rollback_procedure": { "type": "string" }
                        },
                        "required": ["step_number", "step_description", "step_type"]
                    }
                },
                "estimated_duration_minutes": { "type": "integer", "minimum": 1 },
                "risk_level": {
                    "type": "string",
                    "enum": ["low", "medium", "high", "critical"]
                },
                "prerequisites": {
                    "type": "array",
                    "items": { "type": "string" }
                },
                "post_upgrade_validation": {
                    "type": "array",
                    "items": { "type": "string" }
                }
            },
            "required": ["path_id", "from_version", "to_version", "upgrade_steps", "risk_level"]
        },
        "deprecation_schedule": {
            "type": "object",
            "properties": {
                "schedule_version": { "$ref": "#/$defs/version" },
                "deprecation_policies": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "policy_name": { "type": "string" },
                            "deprecation_period_months": { "type": "integer", "minimum": 1 },
                            "notification_schedule": {
                                "type": "array",
                                "items": {
                                    "type": "object",
                                    "properties": {
                                        "notification_type": {
                                            "type": "string",
                                            "enum": ["warning", "deprecation", "removal_notice"]
                                        },
                                        "months_before_removal": { "type": "integer", "minimum": 0 }
                                    },
                                    "required": ["notification_type", "months_before_removal"]
                                }
                            },
                            "affected_features": {
                                "type": "array",
                                "items": { "type": "string" }
                            }
                        },
                        "required": ["policy_name", "deprecation_period_months", "notification_schedule"]
                    }
                },
                "scheduled_deprecations": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "item_type": {
                                "type": "string",
                                "enum": ["module", "api", "field", "enum_value", "feature"]
                            },
                            "item_identifier": { "type": "string" },
                            "deprecation_date": { "$ref": "#/$defs/timestamp" },
                            "removal_date": { "$ref": "#/$defs/timestamp" },
                            "replacement": { "type": "string" },
                            "migration_guide": { "type": "string" },
                            "impact_assessment": { "type": "string" }
                        },
                        "required": ["item_type", "item_identifier", "deprecation_date", "removal_date"]
                    }
                }
            },
            "required": ["schedule_version", "deprecation_policies"]
        },
        "protocol_version_info": {
            "type": "object",
            "properties": {
                "protocol_suite_version": { "$ref": "#/$defs/version" },
                "protocol_suite_name": {
                    "type": "string",
                    "const": "MPLP - Multi-Agent Protocol Lifecycle Platform"
                },
                "release_date": { "$ref": "#/$defs/timestamp" },
                "module_versions": {
                    "type": "array",
                    "items": { "$ref": "#/$defs/module_version_info" },
                    "minItems": 1
                },
                "compatibility_matrix": { "$ref": "#/$defs/compatibility_matrix" },
                "upgrade_paths": {
                    "type": "array",
                    "items": { "$ref": "#/$defs/upgrade_path" }
                },
                "deprecation_schedule": { "$ref": "#/$defs/deprecation_schedule" },
                "release_notes": {
                    "type": "object",
                    "properties": {
                        "new_features": {
                            "type": "array",
                            "items": { "type": "string" }
                        },
                        "improvements": {
                            "type": "array",
                            "items": { "type": "string" }
                        },
                        "bug_fixes": {
                            "type": "array",
                            "items": { "type": "string" }
                        },
                        "breaking_changes": {
                            "type": "array",
                            "items": { "type": "string" }
                        },
                        "security_updates": {
                            "type": "array",
                            "items": { "type": "string" }
                        }
                    }
                },
                "metadata": {
                    "type": "object",
                    "properties": {
                        "maintainers": {
                            "type": "array",
                            "items": { "type": "string" }
                        },
                        "repository_url": { "type": "string", "format": "uri" },
                        "documentation_url": { "type": "string", "format": "uri" },
                        "support_contact": { "type": "string" },
                        "license": { "type": "string" }
                    }
                }
            },
            "required": ["protocol_suite_version", "protocol_suite_name", "release_date", "module_versions", "compatibility_matrix"]
        }
    },
    "properties": {
        "protocol_version": {
            "type": "string",
            "const": "1.0.0",
            "description": "MPLP协议版本"
        },
        "timestamp": {
            "type": "string",
            "format": "date-time",
            "description": "ISO 8601格式时间戳"
        },
        "protocol_version_info": { "$ref": "#/$defs/protocol_version_info" },
        "audit_trail": {
            "type": "object",
            "properties": {
                "enabled": { "type": "boolean" },
                "retention_days": { "type": "integer", "minimum": 1, "maximum": 2555 },
                "audit_events": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "event_id": { "$ref": "#/$defs/uuid" },
                            "event_type": {
                                "type": "string",
                                "enum": ["version_checked", "version_upgraded", "version_downgraded", "compatibility_verified", "migration_executed", "deprecation_warned", "version_conflict_detected", "protocol_evolved"]
                            },
                            "timestamp": { "$ref": "#/$defs/timestamp" },
                            "user_id": { "type": "string" },
                            "user_role": { "type": "string" },
                            "action": { "type": "string" },
                            "resource": { "type": "string" },
                            "version_operation": { "type": "string" },
                            "source_version": { "$ref": "#/$defs/version" },
                            "target_version": { "$ref": "#/$defs/version" },
                            "module_name": { "type": "string" },
                            "compatibility_result": { "$ref": "#/$defs/compatibility_level" },
                            "version_details": { "type": "object" },
                            "ip_address": { "type": "string" },
                            "user_agent": { "type": "string" },
                            "session_id": { "type": "string" },
                            "correlation_id": { "$ref": "#/$defs/uuid" }
                        },
                        "required": ["event_id", "event_type", "timestamp", "user_id", "action", "resource"]
                    }
                },
                "compliance_settings": {
                    "type": "object",
                    "properties": {
                        "gdpr_enabled": { "type": "boolean" },
                        "hipaa_enabled": { "type": "boolean" },
                        "sox_enabled": { "type": "boolean" },
                        "version_audit_level": {
                            "type": "string",
                            "enum": ["basic", "detailed", "comprehensive"]
                        },
                        "version_change_logging": { "type": "boolean" },
                        "custom_compliance": {
                            "type": "array",
                            "items": { "type": "string" }
                        }
                    }
                }
            },
            "required": ["enabled", "retention_days"]
        },
        "monitoring_integration": {
            "type": "object",
            "properties": {
                "enabled": { "type": "boolean" },
                "supported_providers": {
                    "type": "array",
                    "items": {
                        "type": "string",
                        "enum": ["prometheus", "grafana", "datadog", "new_relic", "elastic_apm", "custom"]
                    }
                },
                "integration_endpoints": {
                    "type": "object",
                    "properties": {
                        "metrics_api": { "type": "string", "format": "uri" },
                        "version_management_api": { "type": "string", "format": "uri" },
                        "compatibility_analysis_api": { "type": "string", "format": "uri" },
                        "protocol_evolution_api": { "type": "string", "format": "uri" }
                    }
                },
                "version_metrics": {
                    "type": "object",
                    "properties": {
                        "track_version_management": { "type": "boolean" },
                        "track_compatibility_analysis": { "type": "boolean" },
                        "track_protocol_evolution": { "type": "boolean" },
                        "track_migration_progress": { "type": "boolean" }
                    }
                },
                "export_formats": {
                    "type": "array",
                    "items": {
                        "type": "string",
                        "enum": ["prometheus", "opentelemetry", "custom"]
                    }
                }
            },
            "required": ["enabled", "supported_providers"]
        },
        "performance_metrics": {
            "type": "object",
            "properties": {
                "enabled": { "type": "boolean" },
                "collection_interval_seconds": { "type": "integer", "minimum": 10, "maximum": 3600 },
                "metrics": {
                    "type": "object",
                    "properties": {
                        "version_check_latency_ms": { "type": "number", "minimum": 0 },
                        "compatibility_check_success_rate_percent": { "type": "number", "minimum": 0, "maximum": 100 },
                        "migration_completion_rate_percent": { "type": "number", "minimum": 0, "maximum": 100 },
                        "protocol_evolution_score": { "type": "number", "minimum": 0, "maximum": 10 },
                        "version_adoption_rate_percent": { "type": "number", "minimum": 0, "maximum": 100 },
                        "active_versions_count": { "type": "integer", "minimum": 0 },
                        "deprecated_versions_count": { "type": "integer", "minimum": 0 },
                        "compatibility_conflicts_count": { "type": "integer", "minimum": 0 },
                        "average_migration_time_hours": { "type": "number", "minimum": 0 }
                    }
                },
                "health_status": {
                    "type": "object",
                    "properties": {
                        "status": {
                            "type": "string",
                            "enum": ["healthy", "degraded", "unhealthy", "incompatible"]
                        },
                        "last_check": { "$ref": "#/$defs/timestamp" },
                        "checks": {
                            "type": "array",
                            "items": {
                                "type": "object",
                                "properties": {
                                    "check_name": { "type": "string" },
                                    "status": {
                                        "type": "string",
                                        "enum": ["pass", "fail", "warn"]
                                    },
                                    "message": { "type": "string" },
                                    "duration_ms": { "type": "number", "minimum": 0 }
                                },
                                "required": ["check_name", "status"]
                            }
                        }
                    }
                },
                "alerting": {
                    "type": "object",
                    "properties": {
                        "enabled": { "type": "boolean" },
                        "thresholds": {
                            "type": "object",
                            "properties": {
                                "max_version_check_latency_ms": { "type": "number", "minimum": 0 },
                                "min_compatibility_check_success_rate_percent": { "type": "number", "minimum": 0, "maximum": 100 },
                                "min_migration_completion_rate_percent": { "type": "number", "minimum": 0, "maximum": 100 },
                                "min_protocol_evolution_score": { "type": "number", "minimum": 0, "maximum": 10 },
                                "max_compatibility_conflicts_count": { "type": "integer", "minimum": 0 }
                            }
                        },
                        "notification_channels": {
                            "type": "array",
                            "items": {
                                "type": "string",
                                "enum": ["email", "slack", "webhook", "sms", "pagerduty"]
                            }
                        }
                    }
                }
            },
            "required": ["enabled", "collection_interval_seconds"]
        },
        "version_history": {
            "type": "object",
            "properties": {
                "enabled": { "type": "boolean" },
                "max_versions": { "type": "integer", "minimum": 1, "maximum": 100, "default": 50 },
                "versions": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "version_id": { "$ref": "#/$defs/uuid" },
                            "version_number": { "type": "integer", "minimum": 1 },
                            "created_at": { "$ref": "#/$defs/timestamp" },
                            "created_by": { "type": "string" },
                            "change_summary": { "type": "string" },
                            "protocol_snapshot": { "type": "object" },
                            "change_type": {
                                "type": "string",
                                "enum": ["protocol_created", "version_upgraded", "compatibility_updated", "deprecation_scheduled", "migration_path_added"]
                            }
                        },
                        "required": ["version_id", "version_number", "created_at", "created_by", "change_type"]
                    }
                },
                "auto_versioning": {
                    "type": "object",
                    "properties": {
                        "enabled": { "type": "boolean" },
                        "version_on_protocol_change": { "type": "boolean" },
                        "version_on_compatibility_change": { "type": "boolean" },
                        "version_on_deprecation_change": { "type": "boolean" }
                    }
                }
            },
            "required": ["enabled", "max_versions"]
        },
        "search_metadata": {
            "type": "object",
            "properties": {
                "enabled": { "type": "boolean" },
                "indexing_strategy": {
                    "type": "string",
                    "enum": ["full_text", "keyword", "semantic", "hybrid"]
                },
                "searchable_fields": {
                    "type": "array",
                    "items": {
                        "type": "string",
                        "enum": ["protocol_version", "module_name", "compatibility_level", "version_info", "migration_data", "performance_metrics", "metadata", "audit_logs"]
                    }
                },
                "search_indexes": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "index_id": { "type": "string" },
                            "index_name": { "type": "string" },
                            "fields": { "type": "array", "items": { "type": "string" } },
                            "index_type": {
                                "type": "string",
                                "enum": ["btree", "hash", "gin", "gist", "full_text"]
                            },
                            "created_at": { "$ref": "#/$defs/timestamp" },
                            "last_updated": { "$ref": "#/$defs/timestamp" }
                        },
                        "required": ["index_id", "index_name", "fields", "index_type"]
                    }
                },
                "version_indexing": {
                    "type": "object",
                    "properties": {
                        "enabled": { "type": "boolean" },
                        "index_version_data": { "type": "boolean" },
                        "index_performance_metrics": { "type": "boolean" },
                        "index_audit_logs": { "type": "boolean" }
                    }
                },
                "auto_indexing": {
                    "type": "object",
                    "properties": {
                        "enabled": { "type": "boolean" },
                        "index_new_versions": { "type": "boolean" },
                        "reindex_interval_hours": { "type": "integer", "minimum": 1 }
                    }
                }
            },
            "required": ["enabled", "indexing_strategy"]
        },
        "protocol_version_operation": {
            "type": "string",
            "enum": [
                "create",
                "update",
                "activate",
                "deprecate",
                "migrate"
            ],
            "description": "协议版本操作类型"
        },
        "protocol_version_details": {
            "type": "object",
            "properties": {
                "compatibility_mode": {
                    "type": "string",
                    "enum": [
                        "strict",
                        "backward",
                        "forward",
                        "full"
                    ]
                },
                "migration_strategy": {
                    "type": "string"
                },
                "rollback_support": {
                    "type": "boolean"
                }
            },
            "description": "协议版本详细信息"
        },
        "event_integration": {
            "type": "object",
            "properties": {
                "enabled": { "type": "boolean" },
                "event_bus_connection": {
                    "type": "object",
                    "properties": {
                        "bus_type": {
                            "type": "string",
                            "enum": ["kafka", "rabbitmq", "redis", "nats", "custom"]
                        },
                        "connection_string": { "type": "string" },
                        "topic_prefix": { "type": "string" },
                        "consumer_group": { "type": "string" }
                    }
                },
                "published_events": {
                    "type": "array",
                    "items": {
                        "type": "string",
                        "enum": ["protocolversion_version_checked", "protocolversion_version_upgraded", "protocolversion_compatibility_verified", "protocolversion_migration_executed", "protocolversion_deprecation_warned", "protocolversion_conflict_detected", "protocolversion_protocol_evolved"]
                    }
                },
                "subscribed_events": {
                    "type": "array",
                    "items": {
                        "type": "string",
                        "enum": ["context_updated", "plan_executed", "confirm_approved", "trace_completed", "role_assigned", "extension_activated", "dialog_started", "network_connected", "collab_coordinated", "orchestration_executed", "coordination_synchronized", "event_bus_message_published", "state_sync_sync_completed", "transaction_committed"]
                    }
                },
                "event_routing": {
                    "type": "object",
                    "properties": {
                        "routing_rules": {
                            "type": "array",
                            "items": {
                                "type": "object",
                                "properties": {
                                    "rule_id": { "type": "string" },
                                    "condition": { "type": "string" },
                                    "target_topic": { "type": "string" },
                                    "enabled": { "type": "boolean" }
                                },
                                "required": ["rule_id", "condition", "target_topic"]
                            }
                        }
                    }
                }
            },
            "required": ["enabled"]
        }
    },
    "required": ["protocol_version", "timestamp", "protocol_version_info", "audit_trail", "monitoring_integration", "performance_metrics", "version_history", "search_metadata", "protocol_version_operation", "event_integration"]
}
