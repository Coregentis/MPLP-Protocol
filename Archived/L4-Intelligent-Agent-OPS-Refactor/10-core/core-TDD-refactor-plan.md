# Core模块 TDD重构任务计划

## 📋 **重构概述**

**模块**: Core (CoreOrchestrator统一执行引擎)  
**重构类型**: TDD (Test-Driven Development)  
**目标**: 达到L4智能体操作系统标准  
**基于规则**: `.augment/rules/import-all.mdc`, `.augment/rules/testing-strategy-new.mdc`  
**完成标准**: Extension模块L4标准 (54功能测试100%通过率, 8个MPLP模块预留接口)

## 🎯 **基于修正定位的L4功能分析**

### **Core模块核心定位**
基于`core-MPLP-positioning-analysis.md`系统性批判性思维分析：

**L4架构定位**: L4智能体操作系统执行层(L3)的唯一核心组件  
**核心特色**: CoreOrchestrator统一执行引擎，工作流编排和模块协调中枢  
**与其他模块关系**: 统一编排协调层(L2)的9个协调模块  
**L4标准**: 执行引擎专业化 + 企业级工作流治理 + 智能化编排协调

#### **1. 工作流编排引擎 (核心特色)**
- [ ] 支持1000+并发工作流编排
- [ ] 工作流编排智能调度算法
- [ ] 执行模式自适应选择系统 (sequential/parallel/conditional/hybrid)
- [ ] 工作流性能监控和分析引擎
- [ ] 工作流优化策略生成机制

#### **2. 模块协调中枢 (核心特色)**
- [ ] 9个协调模块的统一协调管理
- [ ] 跨模块事务管理算法 (≥99.9%一致性)
- [ ] 模块状态同步机制 (<10ms响应)
- [ ] 模块协调性能优化引擎
- [ ] 模块协调中枢管理系统

#### **3. 执行策略管理器 (L4标准)**
- [ ] 多种执行策略智能选择 (≥95%准确率)
- [ ] 执行策略动态调整 (≥40%优化效果)
- [ ] 执行性能实时优化 (<50ms响应)
- [ ] 执行策略效果评估
- [ ] 执行策略管理引擎

#### **4. 全局状态管理器 (L4智能化)**
- [ ] 全局状态一致性管理 (≥99.9%一致性)
- [ ] 执行上下文智能管理 (≥98%准确率)
- [ ] 结果聚合和分析 (<100ms响应)
- [ ] 状态管理性能优化
- [ ] 全局状态管理引擎

#### **5. 事件总线协调器**
- [ ] 高性能事件总线管理 (≥10000 events/sec)
- [ ] 智能消息路由 (≥99.5%准确率)
- [ ] 事件处理协调 (<5ms延迟)
- [ ] 事件总线性能优化
- [ ] 事件总线协调引擎

#### **6. MPLP执行引擎集成**
- [ ] 9个协调模块编排接口 (Context, Plan, Confirm, Trace, Role, Extension, Collab, Dialog, Network)
- [ ] 智能层协作接口支持 (AI驱动决策接收)
- [ ] CoreOrchestrator统一执行引擎实现 (10种编排场景)
- [ ] 执行引擎特色接口实现 (体现执行层专业化)
- [ ] 执行引擎事件总线和状态管理

## 🔍 **当前代码分析**

### **现有实现状态**
基于 `src/modules/core/` 分析：

#### **✅ 已实现组件**
- [x] Schema定义 (`mplp-core.json`) - 完整的工作流协议定义
- [x] TypeScript类型 (`types.ts`) - 348行完整类型定义
- [x] 领域实体 (`workflow-execution.entity.ts`) - 387行核心业务逻辑
- [x] DDD架构结构 - 完整的分层架构
- [x] 双重命名约定 - 已正确实现snake_case私有属性

#### **❌ 缺失组件 (TDD重构目标)**
- [ ] Mapper类 - Schema-TypeScript双重命名约定映射
- [ ] DTO类 - API数据传输对象
- [ ] Controller - API控制器
- [ ] Repository实现 - 数据持久化
- [ ] 应用服务 - 工作流管理服务
- [ ] 模块适配器 - MPLP生态系统集成
- [ ] 编排接口 - 9个协调模块编排接口

#### **🚨 质量问题识别 (基于执行引擎特色)**
- [ ] 双重命名约定已正确实现 (entity中使用snake_case私有属性)
- [ ] 缺少Schema验证和映射函数
- [ ] **缺少工作流编排引擎实现**
- [ ] **缺少模块协调中枢核心算法**
- [ ] **缺少执行策略管理器功能**
- [ ] **缺少全局状态管理器能力**
- [ ] **缺少事件总线协调器功能**
- [ ] 缺少MPLP执行引擎特色接口
- [ ] 缺少与智能层的协作机制
- [ ] 缺少完整的执行引擎异常处理和恢复机制

## 📋 **TDD重构任务清单**

### **阶段1: 基础架构重构 (Day 1)**

#### **1.1 Schema-TypeScript映射层**
- [ ] **任务**: 创建 `CoreMapper` 类
  - [ ] 实现 `toSchema()` 方法 (camelCase → snake_case)
  - [ ] 实现 `fromSchema()` 方法 (snake_case → camelCase)
  - [ ] 实现 `validateSchema()` 方法
  - [ ] 实现批量转换方法 `toSchemaArray()`, `fromSchemaArray()`
  - [ ] **测试**: 100%映射一致性验证
  - [ ] **标准**: 遵循 `.augment/rules/dual-naming-convention.mdc`

#### **1.2 DTO层重构**
- [ ] **任务**: 创建完整的DTO类
  - [ ] `CreateWorkflowDto` - 创建工作流请求DTO
  - [ ] `UpdateWorkflowDto` - 更新工作流请求DTO
  - [ ] `WorkflowResponseDto` - 工作流响应DTO
  - [ ] `OrchestrationRequestDto` - 编排请求DTO
  - [ ] **测试**: DTO验证和转换测试
  - [ ] **标准**: 严格类型安全，零any类型

#### **1.3 领域实体增强**
- [ ] **任务**: 增强 `WorkflowExecution` 实体功能
  - [ ] 验证现有双重命名约定实现
  - [ ] 添加Schema映射支持
  - [ ] 增强业务逻辑验证
  - [ ] 添加企业级功能方法
  - [ ] **测试**: 实体业务逻辑完整测试
  - [ ] **标准**: 100%业务规则覆盖

### **阶段2: 执行引擎核心重构 (Day 1-2)**

#### **2.1 工作流编排引擎**
- [ ] **任务**: 实现 `WorkflowOrchestrationEngine`
  - [ ] 工作流编排智能调度算法 (支持1000+并发)
  - [ ] 执行模式自适应选择系统
  - [ ] 工作流性能监控和分析引擎
  - [ ] 工作流优化策略生成机制
  - [ ] **测试**: 工作流编排效率测试 (≥60%提升)
  - [ ] **标准**: 1000+工作流编排支持

#### **2.2 模块协调中枢**
- [ ] **任务**: 实现 `ModuleCoordinationHub`
  - [ ] 9个协调模块的统一协调管理
  - [ ] 跨模块事务管理算法 (≥99.9%一致性)
  - [ ] 模块状态同步机制 (<10ms响应)
  - [ ] 模块协调性能优化引擎
  - [ ] **测试**: 模块协调中枢准确率测试 (≥99.9%)
  - [ ] **标准**: 模块协调中枢系统完整实现

#### **2.3 执行策略管理器**
- [ ] **任务**: 实现 `ExecutionStrategyManager`
  - [ ] 执行策略管理引擎 (≥95%准确率)
  - [ ] 执行模式智能选择算法 (≥40%优化效果)
  - [ ] 执行性能优化系统 (<50ms响应)
  - [ ] 执行策略效果评估机制
  - [ ] **测试**: 执行策略管理性能测试
  - [ ] **标准**: 执行策略管理器系统完整实现

#### **2.4 MPLP执行引擎接口实现**
基于执行引擎特色，实现体现核心定位的编排接口：

**协调层模块编排接口 (9个统一编排模块)**:
- [ ] `orchestrateContextCoordination(contextRequest)` - Context模块编排
- [ ] `orchestratePlanCoordination(planRequest)` - Plan模块编排
- [ ] `orchestrateConfirmCoordination(confirmRequest)` - Confirm模块编排
- [ ] `orchestrateTraceCoordination(traceRequest)` - Trace模块编排
- [ ] `orchestrateRoleCoordination(roleRequest)` - Role模块编排
- [ ] `orchestrateExtensionCoordination(extensionRequest)` - Extension模块编排
- [ ] `orchestrateCollabCoordination(collabRequest)` - Collab模块编排
- [ ] `orchestrateDialogCoordination(dialogRequest)` - Dialog模块编排
- [ ] `orchestrateNetworkCoordination(networkRequest)` - Network模块编排

- [ ] **测试**: 执行引擎接口模拟测试 (重点验证编排特色)
- [ ] **标准**: 体现执行引擎定位，统一编排协调层模块

### **阶段3: 执行智能分析和基础设施 (Day 2)**

#### **3.1 全局状态管理器**
- [ ] **任务**: 实现 `GlobalStateManager`
  - [ ] 全局状态管理引擎 (≥99.9%一致性)
  - [ ] 执行上下文管理系统 (≥98%准确率)
  - [ ] 结果聚合分析机制 (<100ms响应)
  - [ ] 状态管理性能优化算法
  - [ ] **测试**: 全局状态管理算法测试
  - [ ] **标准**: L4全局状态管理能力

#### **3.2 事件总线协调器**
- [ ] **任务**: 实现 `EventBusCoordinator`
  - [ ] 事件总线协调引擎 (≥10000 events/sec)
  - [ ] 消息路由智能算法 (≥99.5%准确率)
  - [ ] 事件处理协调系统 (<5ms延迟)
  - [ ] 事件总线性能优化机制
  - [ ] **测试**: 事件总线协调完整性测试
  - [ ] **标准**: 企业级事件总线协调标准

#### **3.3 高性能执行基础设施**
- [ ] **任务**: 实现企业级 `CoreRepository` 和 `CoreOrchestratorAdapter`
  - [ ] 高性能执行数据持久化 (支持1000+并发)
  - [ ] 执行状态智能缓存和查询优化
  - [ ] 执行事务管理和一致性保证
  - [ ] 执行引擎特色API设计
  - [ ] **测试**: 高并发执行性能测试
  - [ ] **标准**: 企业级执行性能和可靠性

#### **3.4 应用服务层重构**
- [ ] **任务**: 实现 `CoreManagementService`
  - [ ] 工作流生命周期管理服务
  - [ ] 模块协调查询服务
  - [ ] 执行策略分析服务
  - [ ] 全局状态报告服务
  - [ ] **测试**: 应用服务完整单元测试
  - [ ] **标准**: 90%+代码覆盖率

## ✅ **TDD质量门禁**

### **强制质量检查**
每个TDD循环必须通过：

```bash
# TypeScript编译检查 (ZERO ERRORS)
npm run typecheck

# ESLint代码质量检查 (ZERO WARNINGS)  
npm run lint

# 单元测试 (100% PASS)
npm run test:unit:core

# Schema映射一致性检查 (100% CONSISTENCY)
npm run validate:mapping:core

# 双重命名约定检查 (100% COMPLIANCE)
npm run check:naming:core
```

### **覆盖率要求**
- [ ] **单元测试覆盖率**: ≥75% (Extension模块标准)
- [ ] **核心业务逻辑覆盖率**: ≥90%
- [ ] **错误处理覆盖率**: ≥95%
- [ ] **边界条件覆盖率**: ≥85%

### **L4执行引擎性能基准**
- [ ] **工作流编排**: <100ms (1000+工作流)
- [ ] **模块协调**: <10ms (跨模块事务)
- [ ] **执行策略**: <50ms (策略调整)
- [ ] **全局状态**: <100ms (状态聚合)
- [ ] **事件总线**: <5ms (事件处理)
- [ ] **执行系统可用性**: ≥99.9% (企业级SLA)
- [ ] **并发执行支持**: 1000+ (工作流数量)
- [ ] **智能层协作**: <20ms (请求-响应延迟)

## 🚨 **风险控制**

### **技术风险**
- [ ] **风险**: 大规模工作流编排复杂性
  - **缓解**: 使用分层编排和渐进扩容策略
- [ ] **风险**: 模块协调算法复杂
  - **缓解**: 参考Extension模块成功模式，分步实现

### **质量风险**  
- [ ] **风险**: 测试覆盖率不达标
  - **缓解**: 每个功能先写测试，后写实现
- [ ] **风险**: 大规模执行性能不达标
  - **缓解**: 每个组件都包含性能测试和优化

## 📊 **完成标准**

### **TDD阶段完成标准 (执行引擎特色)**
- [x] 所有质量门禁100%通过
- [x] 单元测试覆盖率≥75%
- [x] **工作流编排引擎100%实现** (支持1000+工作流编排)
- [x] **模块协调中枢100%实现** (≥99.9%跨模块事务一致性)
- [x] **执行策略管理器100%实现** (≥95%执行策略智能选择准确率)
- [x] **全局状态管理器100%实现** (≥99.9%全局状态一致性)
- [x] **事件总线协调器100%实现** (≥10000 events/sec吞吐量)
- [x] 9个MPLP执行引擎接口100%实现 (体现执行引擎特色)
- [x] 与智能层协作机制100%实现
- [x] 双重命名约定100%合规
- [x] 零技术债务 (0 any类型, 0 TypeScript错误)
- [x] L4智能体操作系统执行层性能基准100%达标

**完成TDD阶段后，进入BDD重构阶段**

---

**文档版本**: v1.0.0  
**创建时间**: 2025-08-12  
**基于规则**: MPLP v1.0开发规则 + Extension模块L4成功经验  
**下一步**: 完成TDD后执行 `core-BDD-refactor-plan.md`
