{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mplp.dev/schemas/v1.0/mplp-orchestration.json",
  "title": "MPLP CoreOrchestrator Protocol v1.0",
  "description": "多智能体协议生命周期平台CoreOrchestrator统一编排协议Schema",
  "version": "1.0.0",
  "type": "object",
  "$defs": {
    "uuid": {
      "type": "string",
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$",
      "description": "UUID v4 format"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp"
    },
    "module_type": {
      "type": "string",
      "enum": ["context", "plan", "confirm", "trace", "role", "extension", "collab", "dialog", "network"],
      "description": "协调层模块类型"
    },
    "execution_mode": {
      "type": "string",
      "enum": ["sequential", "parallel", "conditional", "hybrid"],
      "description": "工作流执行模式"
    },
    "workflow_status": {
      "type": "string",
      "enum": ["pending", "running", "completed", "failed", "cancelled", "paused"],
      "description": "工作流状态"
    },
    "coordination_step": {
      "type": "object",
      "properties": {
        "step_id": {"$ref": "#/$defs/uuid"},
        "step_name": {
          "type": "string",
          "description": "步骤名称"
        },
        "target_module": {"$ref": "#/$defs/module_type"},
        "operation": {
          "type": "string",
          "description": "目标模块操作"
        },
        "input_data": {
          "type": "object",
          "description": "输入数据"
        },
        "dependencies": {
          "type": "array",
          "items": {"$ref": "#/$defs/uuid"},
          "description": "依赖的步骤ID列表"
        },
        "timeout_ms": {
          "type": "integer",
          "minimum": 1000,
          "default": 30000,
          "description": "步骤超时时间(毫秒)"
        },
        "retry_policy": {
          "type": "object",
          "properties": {
            "max_retries": {
              "type": "integer",
              "minimum": 0,
              "maximum": 5,
              "default": 3
            },
            "retry_delay_ms": {
              "type": "integer",
              "minimum": 100,
              "default": 1000
            },
            "backoff_multiplier": {
              "type": "number",
              "minimum": 1.0,
              "default": 2.0
            }
          }
        }
      ,
    "orchestration_details": {
      "type": "object",
      "properties": {
        "orchestration_pattern": {
          "type": "string",
          "enum": [
            "sequential",
            "parallel",
            "conditional",
            "loop"
          ]
        },
        "resource_allocation": {
          "type": "string",
          "enum": [
            "static",
            "dynamic",
            "adaptive"
          ]
        },
        "failure_handling": {
          "type": "string",
          "enum": [
            "retry",
            "fallback",
            "circuit_breaker"
          ]
        }
      }
    }
  },
  "required": ["step_id", "step_name", "target_module", "operation", "input_data"]
    },
    "coordination_plan": {
      "type": "object",
      "properties": {
        "plan_id": {"$ref": "#/$defs/uuid"},
        "plan_name": {
          "type": "string",
          "description": "协调计划名称"
        },
        "steps": {
          "type": "array",
          "items": {"$ref": "#/$defs/coordination_step"},
          "minItems": 1,
          "description": "协调步骤列表"
        },
        "execution_mode": {"$ref": "#/$defs/execution_mode"},
        "global_timeout_ms": {
          "type": "integer",
          "minimum": 5000,
          "default": 300000,
          "description": "全局超时时间(毫秒)"
        },
        "rollback_strategy": {
          "type": "string",
          "enum": ["none", "compensate", "rollback", "manual"],
          "default": "compensate",
          "description": "回滚策略"
        }
      },
      "required": ["plan_id", "plan_name", "steps", "execution_mode"]
    },
    "performance_requirements": {
      "type": "object",
      "properties": {
        "max_execution_time_ms": {
          "type": "integer",
          "minimum": 1000,
          "description": "最大执行时间要求"
        },
        "max_memory_mb": {
          "type": "integer",
          "minimum": 1,
          "description": "最大内存使用要求"
        },
        "min_success_rate": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "default": 0.99,
          "description": "最小成功率要求"
        },
        "max_concurrent_steps": {
          "type": "integer",
          "minimum": 1,
          "default": 10,
          "description": "最大并发步骤数"
        }
      }
    },
    "orchestration_request": {
      "type": "object",
      "properties": {
        "workflow_id": {"$ref": "#/$defs/uuid"},
        "workflow_name": {
          "type": "string",
          "description": "工作流名称"
        },
        "coordination_plan": {"$ref": "#/$defs/coordination_plan"},
        "global_context": {
          "type": "object",
          "description": "全局上下文数据"
        },
        "performance_requirements": {"$ref": "#/$defs/performance_requirements"},
        "priority": {
          "type": "string",
          "enum": ["low", "normal", "high", "urgent", "critical"],
          "default": "normal"
        },
        "created_by": {
          "type": "string",
          "description": "创建者标识"
        },
        "created_at": {"$ref": "#/$defs/timestamp"}
      },
      "required": ["workflow_id", "workflow_name", "coordination_plan", "created_at"]
    },
    "orchestration_response": {
      "type": "object",
      "properties": {
        "workflow_id": {"$ref": "#/$defs/uuid"},
        "execution_id": {"$ref": "#/$defs/uuid"},
        "status": {"$ref": "#/$defs/workflow_status"},
        "progress": {
          "type": "object",
          "properties": {
            "completed_steps": {
              "type": "integer",
              "minimum": 0
            },
            "total_steps": {
              "type": "integer",
              "minimum": 1
            },
            "current_step": {"$ref": "#/$defs/uuid"},
            "completion_percentage": {
              "type": "number",
              "minimum": 0.0,
              "maximum": 100.0
            }
          },
          "required": ["completed_steps", "total_steps", "completion_percentage"]
        },
        "results": {
          "type": "object",
          "description": "执行结果数据"
        },
        "execution_metrics": {
          "type": "object",
          "properties": {
            "start_time": {"$ref": "#/$defs/timestamp"},
            "end_time": {"$ref": "#/$defs/timestamp"},
            "total_execution_time_ms": {
              "type": "integer",
              "minimum": 0
            },
            "memory_usage_mb": {
              "type": "number",
              "minimum": 0
            },
            "success_rate": {
              "type": "number",
              "minimum": 0.0,
              "maximum": 1.0
            }
          }
        },
        "error_info": {
          "type": "object",
          "properties": {
            "error_code": {
              "type": "string",
              "pattern": "^[A-Z]{4}[0-9]{4}$"
            },
            "error_message": {"type": "string"},
            "failed_step": {"$ref": "#/$defs/uuid"},
            "error_details": {"type": "object"}
          }
        },
        "updated_at": {"$ref": "#/$defs/timestamp"}
      },
      "required": ["workflow_id", "execution_id", "status", "updated_at"]
    }
  },
  "properties": {
    "protocol_version": {
      "type": "string",
      "const": "1.0.0",
      "description": "MPLP协议版本"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601格式时间戳"
    },
    "orchestration_request": {"$ref": "#/$defs/orchestration_request"},
    "orchestration_response": {"$ref": "#/$defs/orchestration_response"},
    "audit_trail": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },
        "retention_days": { "type": "integer", "minimum": 1, "maximum": 2555 },
        "audit_events": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "event_id": { "$ref": "#/$defs/uuid" },
              "event_type": {
                "type": "string",
                "enum": ["workflow_started", "workflow_completed", "workflow_failed", "step_executed", "resource_allocated", "rollback_triggered", "timeout_occurred", "dependency_resolved"]
              },
              "timestamp": { "$ref": "#/$defs/timestamp" },
              "user_id": { "type": "string" },
              "user_role": { "type": "string" },
              "action": { "type": "string" },
              "resource": { "type": "string" },
              "orchestration_operation": { "type": "string" },
              "workflow_id": { "$ref": "#/$defs/uuid" },
              "step_id": { "$ref": "#/$defs/uuid" },
              "execution_details": { "type": "object" },
              "ip_address": { "type": "string" },
              "user_agent": { "type": "string" },
              "session_id": { "type": "string" },
              "correlation_id": { "$ref": "#/$defs/uuid" }
            },
            "required": ["event_id", "event_type", "timestamp", "user_id", "action", "resource"]
          }
        },
        "compliance_settings": {
          "type": "object",
          "properties": {
            "gdpr_enabled": { "type": "boolean" },
            "hipaa_enabled": { "type": "boolean" },
            "sox_enabled": { "type": "boolean" },
            "orchestration_audit_level": {
              "type": "string",
              "enum": ["basic", "detailed", "comprehensive"]
            },
            "workflow_logging": { "type": "boolean" },
            "custom_compliance": {
              "type": "array",
              "items": { "type": "string" }
            }
          }
        }
      },
      "required": ["enabled", "retention_days"]
    },
    "monitoring_integration": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },
        "supported_providers": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["prometheus", "grafana", "datadog", "new_relic", "elastic_apm", "custom"]
          }
        },
        "integration_endpoints": {
          "type": "object",
          "properties": {
            "metrics_api": { "type": "string", "format": "uri" },
            "workflow_execution_api": { "type": "string", "format": "uri" },
            "resource_utilization_api": { "type": "string", "format": "uri" },
            "orchestration_efficiency_api": { "type": "string", "format": "uri" }
          }
        },
        "orchestration_metrics": {
          "type": "object",
          "properties": {
            "track_workflow_execution": { "type": "boolean" },
            "track_resource_utilization": { "type": "boolean" },
            "track_orchestration_efficiency": { "type": "boolean" },
            "track_dependency_resolution": { "type": "boolean" }
          }
        },
        "export_formats": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["prometheus", "opentelemetry", "custom"]
          }
        }
      },
      "required": ["enabled", "supported_providers"]
    },
    "performance_metrics": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },
        "collection_interval_seconds": { "type": "integer", "minimum": 10, "maximum": 3600 },
        "metrics": {
          "type": "object",
          "properties": {
            "workflow_execution_time_ms": { "type": "number", "minimum": 0 },
            "orchestration_efficiency_percent": { "type": "number", "minimum": 0, "maximum": 100 },
            "resource_utilization_percent": { "type": "number", "minimum": 0, "maximum": 100 },
            "step_success_rate_percent": { "type": "number", "minimum": 0, "maximum": 100 },
            "dependency_resolution_time_ms": { "type": "number", "minimum": 0 },
            "active_workflows_count": { "type": "integer", "minimum": 0 },
            "failed_workflows_count": { "type": "integer", "minimum": 0 },
            "rollback_frequency_percent": { "type": "number", "minimum": 0, "maximum": 100 },
            "average_step_execution_time_ms": { "type": "number", "minimum": 0 }
          }
        },
        "health_status": {
          "type": "object",
          "properties": {
            "status": {
              "type": "string",
              "enum": ["healthy", "degraded", "unhealthy", "overloaded"]
            },
            "last_check": { "$ref": "#/$defs/timestamp" },
            "checks": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "check_name": { "type": "string" },
                  "status": {
                    "type": "string",
                    "enum": ["pass", "fail", "warn"]
                  },
                  "message": { "type": "string" },
                  "duration_ms": { "type": "number", "minimum": 0 }
                },
                "required": ["check_name", "status"]
              }
            }
          }
        },
        "alerting": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean" },
            "thresholds": {
              "type": "object",
              "properties": {
                "max_workflow_execution_time_ms": { "type": "number", "minimum": 0 },
                "min_orchestration_efficiency_percent": { "type": "number", "minimum": 0, "maximum": 100 },
                "max_resource_utilization_percent": { "type": "number", "minimum": 0, "maximum": 100 },
                "min_step_success_rate_percent": { "type": "number", "minimum": 0, "maximum": 100 },
                "max_rollback_frequency_percent": { "type": "number", "minimum": 0, "maximum": 100 }
              }
            },
            "notification_channels": {
              "type": "array",
              "items": {
                "type": "string",
                "enum": ["email", "slack", "webhook", "sms", "pagerduty"]
              }
            }
          }
        }
      },
      "required": ["enabled", "collection_interval_seconds"]
    },
    "version_history": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },
        "max_versions": { "type": "integer", "minimum": 1, "maximum": 100, "default": 50 },
        "versions": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "version_id": { "$ref": "#/$defs/uuid" },
              "version_number": { "type": "integer", "minimum": 1 },
              "created_at": { "$ref": "#/$defs/timestamp" },
              "created_by": { "type": "string" },
              "change_summary": { "type": "string" },
              "orchestration_snapshot": { "type": "object" },
              "change_type": {
                "type": "string",
                "enum": ["workflow_created", "workflow_updated", "plan_modified", "configuration_changed", "performance_tuned"]
              }
            },
            "required": ["version_id", "version_number", "created_at", "created_by", "change_type"]
          }
        },
        "auto_versioning": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean" },
            "version_on_workflow_change": { "type": "boolean" },
            "version_on_plan_change": { "type": "boolean" },
            "version_on_config_change": { "type": "boolean" }
          }
        }
      },
      "required": ["enabled", "max_versions"]
    },
    "search_metadata": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },
        "indexing_strategy": {
          "type": "string",
          "enum": ["full_text", "keyword", "semantic", "hybrid"]
        },
        "searchable_fields": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["workflow_id", "plan_name", "steps", "execution_metrics", "orchestration_data", "metadata", "audit_logs"]
          }
        },
        "search_indexes": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "index_id": { "type": "string" },
              "index_name": { "type": "string" },
              "fields": { "type": "array", "items": { "type": "string" } },
              "index_type": {
                "type": "string",
                "enum": ["btree", "hash", "gin", "gist", "full_text"]
              },
              "created_at": { "$ref": "#/$defs/timestamp" },
              "last_updated": { "$ref": "#/$defs/timestamp" }
            },
            "required": ["index_id", "index_name", "fields", "index_type"]
          }
        },
        "orchestration_indexing": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean" },
            "index_workflow_data": { "type": "boolean" },
            "index_execution_metrics": { "type": "boolean" },
            "index_audit_logs": { "type": "boolean" }
          }
        },
        "auto_indexing": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean" },
            "index_new_workflows": { "type": "boolean" },
            "reindex_interval_hours": { "type": "integer", "minimum": 1 }
          }
        }
      },
      "required": ["enabled", "indexing_strategy"]
    },

    "orchestration_details": {

      "type": "object",

      "properties": {

        "orchestration_pattern": {

          "type": "string",

          "enum": [

            "sequential",

            "parallel",

            "conditional",

            "loop"

          ]

        },

        "resource_allocation": {

          "type": "string",

          "enum": [

            "static",

            "dynamic",

            "adaptive"

          ]

        },

        "failure_handling": {

          "type": "string",

          "enum": [

            "retry",

            "fallback",

            "circuit_breaker"

          ]

        }

      },

      "description": "编排详细配置"

    },


    "orchestration_operation": {


      "type": "string",


      "enum": [


        "start",


        "pause",


        "resume",


        "stop",


        "restart"


      ],


      "description": "编排操作类型"


    },
    "event_integration": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },
        "event_bus_connection": {
          "type": "object",
          "properties": {
            "bus_type": {
              "type": "string",
              "enum": ["kafka", "rabbitmq", "redis", "nats", "custom"]
            },
            "connection_string": { "type": "string" },
            "topic_prefix": { "type": "string" },
            "consumer_group": { "type": "string" }
          }
        },
        "published_events": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["orchestration_workflow_started", "orchestration_workflow_completed", "orchestration_workflow_failed", "orchestration_step_executed", "orchestration_resource_allocated", "orchestration_rollback_triggered"]
          }
        },
        "subscribed_events": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["context_updated", "plan_executed", "confirm_approved", "trace_completed", "role_assigned", "extension_activated", "dialog_started", "network_connected", "collab_coordinated"]
          }
        },
        "event_routing": {
          "type": "object",
          "properties": {
            "routing_rules": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "rule_id": { "type": "string" },
                  "condition": { "type": "string" },
                  "target_topic": { "type": "string" },
                  "enabled": { "type": "boolean" }
                },
                "required": ["rule_id", "condition", "target_topic"]
              }
            }
          }
        }
      },
      "required": ["enabled"]
    }
  },
  "oneOf": [
    {"required": ["protocol_version", "timestamp", "orchestration_request", "audit_trail", "monitoring_integration", "performance_metrics", "version_history", "search_metadata", "orchestration_details", "event_integration"]},
    {"required": ["protocol_version", "timestamp", "orchestration_response", "audit_trail", "monitoring_integration", "performance_metrics", "version_history", "search_metadata", "orchestration_details", "event_integration"]}
  ]
}
