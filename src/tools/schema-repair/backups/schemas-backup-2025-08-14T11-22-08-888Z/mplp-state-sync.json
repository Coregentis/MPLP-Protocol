{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mplp.dev/schemas/v1.0/mplp-state-sync.json",
  "title": "MPLP State Synchronization Protocol v1.0",
  "description": "多智能体协议生命周期平台模块间状态同步协议Schema",
  "version": "1.0.0",
  "type": "object",
  "$defs": {
    "uuid": {
      "type": "string",
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$",
      "description": "UUID v4 format"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp"
    },
    "module_type": {
      "type": "string",
      "enum": ["core", "context", "plan", "confirm", "trace", "role", "extension", "collab", "dialog", "network"],
      "description": "MPLP模块类型"
    },
    "sync_strategy": {
      "type": "string",
      "enum": ["push", "pull", "bidirectional", "event_driven", "periodic"],
      "description": "同步策略"
    },
    "consistency_level": {
      "type": "string",
      "enum": ["eventual", "strong", "bounded_staleness", "session", "consistent_prefix"],
      "default": "eventual",
      "description": "一致性级别"
    },
    "conflict_resolution": {
      "type": "string",
      "enum": ["last_write_wins", "first_write_wins", "merge", "manual", "custom"],
      "default": "last_write_wins",
      "description": "冲突解决策略"
    },
    "state_snapshot": {
      "type": "object",
      "properties": {
        "snapshot_id": {"$ref": "#/$defs/uuid"},
        "module": {"$ref": "#/$defs/module_type"},
        "version": {
          "type": "integer",
          "minimum": 1,
          "description": "状态版本号"
        },
        "state_data": {
          "type": "object",
          "description": "状态数据"
        },
        "checksum": {
          "type": "string",
          "description": "状态数据校验和"
        },
        "metadata": {
          "type": "object",
          "properties": {
            "size_bytes": {"type": "integer"},
            "compression": {"type": "string"},
            "encoding": {"type": "string"}
          }
        },
        "created_at": {"$ref": "#/$defs/timestamp"}
      },
      "required": ["snapshot_id", "module", "version", "state_data", "checksum", "created_at"]
    },
    "state_delta": {
      "type": "object",
      "properties": {
        "delta_id": {"$ref": "#/$defs/uuid"},
        "base_version": {
          "type": "integer",
          "minimum": 1,
          "description": "基础版本号"
        },
        "target_version": {
          "type": "integer",
          "minimum": 1,
          "description": "目标版本号"
        },
        "operations": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "operation_type": {
                "type": "string",
                "enum": ["create", "update", "delete", "move"]
              },
              "path": {
                "type": "string",
                "description": "操作路径，使用JSON Pointer格式"
              },
              "old_value": {
                "description": "旧值"
              },
              "new_value": {
                "description": "新值"
              },
              "timestamp": {"$ref": "#/$defs/timestamp"}
            },
            "required": ["operation_type", "path", "timestamp"]
          }
        },
        "checksum": {
          "type": "string",
          "description": "增量数据校验和"
        },
        "created_at": {"$ref": "#/$defs/timestamp"}
      },
      "required": ["delta_id", "base_version", "target_version", "operations", "checksum", "created_at"]
    },
    "state_sync_request": {
      "type": "object",
      "properties": {
        "sync_id": {"$ref": "#/$defs/uuid"},
        "source_module": {"$ref": "#/$defs/module_type"},
        "target_modules": {
          "type": "array",
          "items": {"$ref": "#/$defs/module_type"},
          "minItems": 1,
          "description": "目标模块列表"
        },
        "sync_strategy": {"$ref": "#/$defs/sync_strategy"},
        "consistency_level": {"$ref": "#/$defs/consistency_level"},
        "sync_scope": {
          "type": "object",
          "properties": {
            "include_paths": {
              "type": "array",
              "items": {"type": "string"},
              "description": "包含的状态路径"
            },
            "exclude_paths": {
              "type": "array",
              "items": {"type": "string"},
              "description": "排除的状态路径"
            },
            "filter_conditions": {
              "type": "object",
              "description": "过滤条件"
            }
          }
        },
        "sync_options": {
          "type": "object",
          "properties": {
            "use_delta": {
              "type": "boolean",
              "default": true,
              "description": "是否使用增量同步"
            },
            "compression_enabled": {
              "type": "boolean",
              "default": true
            },
            "batch_size": {
              "type": "integer",
              "minimum": 1,
              "default": 100
            },
            "timeout_ms": {
              "type": "integer",
              "minimum": 1000,
              "default": 30000
            },
            "retry_count": {
              "type": "integer",
              "minimum": 0,
              "default": 3
            }
          }
        },
        "state_snapshot": {"$ref": "#/$defs/state_snapshot"},
        "state_delta": {"$ref": "#/$defs/state_delta"},
        "created_at": {"$ref": "#/$defs/timestamp"}
      },
      "required": ["sync_id", "source_module", "target_modules", "sync_strategy", "created_at"]
    },
    "state_sync_response": {
      "type": "object",
      "properties": {
        "sync_id": {"$ref": "#/$defs/uuid"},
        "response_id": {"$ref": "#/$defs/uuid"},
        "target_module": {"$ref": "#/$defs/module_type"},
        "sync_status": {
          "type": "string",
          "enum": ["success", "partial_success", "failure", "conflict", "timeout"],
          "description": "同步状态"
        },
        "applied_version": {
          "type": "integer",
          "minimum": 1,
          "description": "已应用的版本号"
        },
        "conflicts": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "path": {"type": "string"},
              "conflict_type": {
                "type": "string",
                "enum": ["version_conflict", "data_conflict", "schema_conflict"]
              },
              "local_value": {"description": "本地值"},
              "remote_value": {"description": "远程值"},
              "resolution": {"$ref": "#/$defs/conflict_resolution"},
              "resolved_value": {"description": "解决后的值"}
            },
            "required": ["path", "conflict_type"]
          }
        },
        "sync_metrics": {
          "type": "object",
          "properties": {
            "records_processed": {"type": "integer"},
            "records_applied": {"type": "integer"},
            "records_skipped": {"type": "integer"},
            "processing_time_ms": {"type": "integer"},
            "data_size_bytes": {"type": "integer"}
          }
        },
        "error_info": {
          "type": "object",
          "properties": {
            "error_code": {
              "type": "string",
              "pattern": "^[A-Z]{4}[0-9]{4}$"
            },
            "error_message": {"type": "string"},
            "error_details": {"type": "object"}
          }
        },
        "next_sync_version": {
          "type": "integer",
          "minimum": 1,
          "description": "下次同步的版本号"
        },
        "completed_at": {"$ref": "#/$defs/timestamp"}
      },
      "required": ["sync_id", "response_id", "target_module", "sync_status", "completed_at"]
    },
    "state_sync_subscription": {
      "type": "object",
      "properties": {
        "subscription_id": {"$ref": "#/$defs/uuid"},
        "subscriber_module": {"$ref": "#/$defs/module_type"},
        "source_modules": {
          "type": "array",
          "items": {"$ref": "#/$defs/module_type"},
          "description": "订阅的源模块列表"
        },
        "sync_patterns": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "path_pattern": {
                "type": "string",
                "description": "状态路径匹配模式"
              },
              "sync_strategy": {"$ref": "#/$defs/sync_strategy"},
              "sync_frequency_ms": {
                "type": "integer",
                "minimum": 1000,
                "description": "同步频率(毫秒)"
              }
            },
            "required": ["path_pattern", "sync_strategy"]
          }
        },
        "active": {
          "type": "boolean",
          "default": true
        },
        "created_at": {"$ref": "#/$defs/timestamp"},
        "updated_at": {"$ref": "#/$defs/timestamp"}
      },
      "required": ["subscription_id", "subscriber_module", "source_modules", "sync_patterns", "created_at"]
    }
  },
  "properties": {
    "protocol_version": {
      "type": "string",
      "const": "1.0.0",
      "description": "MPLP协议版本"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601格式时间戳"
    },
    "state_sync_request": {"$ref": "#/$defs/state_sync_request"},
    "state_sync_response": {"$ref": "#/$defs/state_sync_response"},
    "state_sync_subscription": {"$ref": "#/$defs/state_sync_subscription"},
    "audit_trail": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },
        "retention_days": { "type": "integer", "minimum": 1, "maximum": 2555 },
        "audit_events": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "event_id": { "$ref": "#/$defs/uuid" },
              "event_type": {
                "type": "string",
                "enum": ["sync_started", "sync_completed", "sync_failed", "conflict_detected", "conflict_resolved", "state_updated", "snapshot_created", "rollback_executed"]
              },
              "timestamp": { "$ref": "#/$defs/timestamp" },
              "user_id": { "type": "string" },
              "user_role": { "type": "string" },
              "action": { "type": "string" },
              "resource": { "type": "string" },
              "state_sync_operation": { "type": "string" },
              "source_module": { "$ref": "#/$defs/module_type" },
              "target_module": { "$ref": "#/$defs/module_type" },
              "sync_details": { "type": "object" },
              "conflict_details": { "type": "object" },
              "ip_address": { "type": "string" },
              "user_agent": { "type": "string" },
              "session_id": { "type": "string" },
              "correlation_id": { "$ref": "#/$defs/uuid" }
            },
            "required": ["event_id", "event_type", "timestamp", "user_id", "action", "resource"]
          }
        },
        "compliance_settings": {
          "type": "object",
          "properties": {
            "gdpr_enabled": { "type": "boolean" },
            "hipaa_enabled": { "type": "boolean" },
            "sox_enabled": { "type": "boolean" },
            "state_audit_level": {
              "type": "string",
              "enum": ["basic", "detailed", "comprehensive"]
            },
            "state_change_logging": { "type": "boolean" },
            "custom_compliance": {
              "type": "array",
              "items": { "type": "string" }
            }
          }
        }
      },
      "required": ["enabled", "retention_days"]
    },
    "monitoring_integration": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },
        "supported_providers": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["prometheus", "grafana", "datadog", "new_relic", "elastic_apm", "custom"]
          }
        },
        "integration_endpoints": {
          "type": "object",
          "properties": {
            "metrics_api": { "type": "string", "format": "uri" },
            "sync_performance_api": { "type": "string", "format": "uri" },
            "consistency_analysis_api": { "type": "string", "format": "uri" },
            "conflict_resolution_api": { "type": "string", "format": "uri" }
          }
        },
        "state_sync_metrics": {
          "type": "object",
          "properties": {
            "track_sync_performance": { "type": "boolean" },
            "track_consistency_analysis": { "type": "boolean" },
            "track_conflict_resolution": { "type": "boolean" },
            "track_state_integrity": { "type": "boolean" }
          }
        },
        "export_formats": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["prometheus", "opentelemetry", "custom"]
          }
        }
      },
      "required": ["enabled", "supported_providers"]
    },
    "performance_metrics": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },
        "collection_interval_seconds": { "type": "integer", "minimum": 10, "maximum": 3600 },
        "metrics": {
          "type": "object",
          "properties": {
            "sync_latency_ms": { "type": "number", "minimum": 0 },
            "consistency_score": { "type": "number", "minimum": 0, "maximum": 10 },
            "conflict_resolution_time_ms": { "type": "number", "minimum": 0 },
            "sync_success_rate_percent": { "type": "number", "minimum": 0, "maximum": 100 },
            "state_integrity_score": { "type": "number", "minimum": 0, "maximum": 10 },
            "active_syncs_count": { "type": "integer", "minimum": 0 },
            "failed_syncs_count": { "type": "integer", "minimum": 0 },
            "rollback_frequency_percent": { "type": "number", "minimum": 0, "maximum": 100 },
            "average_sync_size_bytes": { "type": "number", "minimum": 0 }
          }
        },
        "health_status": {
          "type": "object",
          "properties": {
            "status": {
              "type": "string",
              "enum": ["healthy", "degraded", "unhealthy", "inconsistent"]
            },
            "last_check": { "$ref": "#/$defs/timestamp" },
            "checks": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "check_name": { "type": "string" },
                  "status": {
                    "type": "string",
                    "enum": ["pass", "fail", "warn"]
                  },
                  "message": { "type": "string" },
                  "duration_ms": { "type": "number", "minimum": 0 }
                },
                "required": ["check_name", "status"]
              }
            }
          }
        },
        "alerting": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean" },
            "thresholds": {
              "type": "object",
              "properties": {
                "max_sync_latency_ms": { "type": "number", "minimum": 0 },
                "min_consistency_score": { "type": "number", "minimum": 0, "maximum": 10 },
                "max_conflict_resolution_time_ms": { "type": "number", "minimum": 0 },
                "min_sync_success_rate_percent": { "type": "number", "minimum": 0, "maximum": 100 },
                "min_state_integrity_score": { "type": "number", "minimum": 0, "maximum": 10 }
              }
            },
            "notification_channels": {
              "type": "array",
              "items": {
                "type": "string",
                "enum": ["email", "slack", "webhook", "sms", "pagerduty"]
              }
            }
          }
        }
      },
      "required": ["enabled", "collection_interval_seconds"]
    },
    "version_history": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },
        "max_versions": { "type": "integer", "minimum": 1, "maximum": 100, "default": 50 },
        "versions": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "version_id": { "$ref": "#/$defs/uuid" },
              "version_number": { "type": "integer", "minimum": 1 },
              "created_at": { "$ref": "#/$defs/timestamp" },
              "created_by": { "type": "string" },
              "change_summary": { "type": "string" },
              "state_sync_snapshot": { "type": "object" },
              "change_type": {
                "type": "string",
                "enum": ["sync_created", "configuration_updated", "patterns_modified", "subscriptions_changed", "consistency_rules_updated"]
              }
            },
            "required": ["version_id", "version_number", "created_at", "created_by", "change_type"]
          }
        },
        "auto_versioning": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean" },
            "version_on_config_change": { "type": "boolean" },
            "version_on_pattern_change": { "type": "boolean" },
            "version_on_subscription_change": { "type": "boolean" }
          }
        }
      },
      "required": ["enabled", "max_versions"]
    },
    "search_metadata": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },
        "indexing_strategy": {
          "type": "string",
          "enum": ["full_text", "keyword", "semantic", "hybrid"]
        },
        "searchable_fields": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["sync_id", "source_module", "target_module", "sync_type", "state_data", "performance_metrics", "metadata", "audit_logs"]
          }
        },
        "search_indexes": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "index_id": { "type": "string" },
              "index_name": { "type": "string" },
              "fields": { "type": "array", "items": { "type": "string" } },
              "index_type": {
                "type": "string",
                "enum": ["btree", "hash", "gin", "gist", "full_text"]
              },
              "created_at": { "$ref": "#/$defs/timestamp" },
              "last_updated": { "$ref": "#/$defs/timestamp" }
            },
            "required": ["index_id", "index_name", "fields", "index_type"]
          }
        },
        "state_indexing": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean" },
            "index_state_data": { "type": "boolean" },
            "index_performance_metrics": { "type": "boolean" },
            "index_audit_logs": { "type": "boolean" }
          }
        },
        "auto_indexing": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean" },
            "index_new_syncs": { "type": "boolean" },
            "reindex_interval_hours": { "type": "integer", "minimum": 1 }
          }
        }
      },
      "required": ["enabled", "indexing_strategy"]
    },

    "state_sync_details": {

      "type": "object",

      "properties": {

        "sync_strategy": {

          "type": "string",

          "enum": [

            "push",

            "pull",

            "bidirectional"

          ]

        },

        "conflict_resolution": {

          "type": "string",

          "enum": [

            "last_write_wins",

            "merge",

            "manual"

          ]

        },

        "consistency_level": {

          "type": "string",

          "enum": [

            "eventual",

            "strong",

            "bounded"

          ]

        }

      },

      "description": "状态同步详细配置"

    },


    "state_sync_operation": {


      "type": "string",


      "enum": [


        "sync",


        "merge",


        "resolve",


        "rollback",


        "snapshot"


      ],


      "description": "状态同步操作类型"


    },
    "event_integration": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },
        "event_bus_connection": {
          "type": "object",
          "properties": {
            "bus_type": {
              "type": "string",
              "enum": ["kafka", "rabbitmq", "redis", "nats", "custom"]
            },
            "connection_string": { "type": "string" },
            "topic_prefix": { "type": "string" },
            "consumer_group": { "type": "string" }
          }
        },
        "published_events": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["statesync_sync_started", "statesync_sync_completed", "statesync_sync_failed", "statesync_conflict_detected", "statesync_conflict_resolved", "statesync_state_updated", "statesync_rollback_executed"]
          }
        },
        "subscribed_events": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["context_updated", "plan_executed", "confirm_approved", "trace_completed", "role_assigned", "extension_activated", "dialog_started", "network_connected", "collab_coordinated", "orchestration_executed", "coordination_synchronized", "eventbus_message_published"]
          }
        },
        "event_routing": {
          "type": "object",
          "properties": {
            "routing_rules": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "rule_id": { "type": "string" },
                  "condition": { "type": "string" },
                  "target_topic": { "type": "string" },
                  "enabled": { "type": "boolean" }
                },
                "required": ["rule_id", "condition", "target_topic"]
              }
            }
          }
        }
      },
      "required": ["enabled"]
    }
  },
  "oneOf": [
    {"required": ["protocol_version", "timestamp", "state_sync_request", "audit_trail", "monitoring_integration", "performance_metrics", "version_history", "search_metadata", "state_sync_details", "event_integration"]},
    {"required": ["protocol_version", "timestamp", "state_sync_response", "audit_trail", "monitoring_integration", "performance_metrics", "version_history", "search_metadata", "state_sync_details", "event_integration"]},
    {"required": ["protocol_version", "timestamp", "state_sync_subscription", "audit_trail", "monitoring_integration", "performance_metrics", "version_history", "search_metadata", "state_sync_details", "event_integration"]}
  ]
}
