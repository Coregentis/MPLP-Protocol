{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://mplp.dev/schemas/v1.0/trace-protocol.json",
  "title": "MPLP Trace Protocol v1.0",
  "description": "Trace模块协议Schema - 追踪记录和监控分析",
  "type": "object",
  "$defs": {
    "uuid": {
      "type": "string",
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$",
      "description": "UUID v4格式的唯一标识符"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601格式的时间戳"
    },
    "version": {
      "type": "string",
      "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-((?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\\.(?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\\+([0-9a-zA-Z-]+(?:\\.[0-9a-zA-Z-]+)*))?$",
      "description": "语义化版本号 (SemVer)"
    },
    "priority": {
      "type": "string",
      "enum": ["critical", "high", "medium", "low"],
      "description": "优先级枚举"
    }
  },
  "properties": {
    "protocol_version": {
      "$ref": "#/$defs/version",
      "description": "MPLP协议版本",
              "const": "1.0.1"
    },
    "timestamp": {
      "$ref": "#/$defs/timestamp",
      "description": "协议消息时间戳"
    },
    "trace_id": {
      "$ref": "#/$defs/uuid",
      "description": "追踪唯一标识符"
    },
    "context_id": {
      "$ref": "#/$defs/uuid",
      "description": "关联的上下文ID"
    },
    "plan_id": {
      "$ref": "#/$defs/uuid",
      "description": "关联的计划ID"
    },
    "task_id": {
      "$ref": "#/$defs/uuid",
      "description": "关联的任务ID"
    },
    "trace_type": {
      "type": "string",
      "enum": ["execution", "monitoring", "audit", "performance", "error", "decision"],
      "description": "跟踪类型"
    },
    "severity": {
      "type": "string",
      "enum": ["debug", "info", "warn", "error", "critical"],
      "description": "严重程度"
    },
    "event": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["start", "progress", "checkpoint", "completion", "failure", "timeout", "interrupt"]
        },
        "name": { "type": "string", "maxLength": 255 },
        "description": { "type": "string", "maxLength": 1000 },
        "category": { "type": "string", "enum": ["system", "user", "external", "automatic"] },
        "source": {
          "type": "object",
          "properties": {
            "component": { "type": "string" },
            "module": { "type": "string" },
            "function": { "type": "string" },
            "line_number": { "type": "integer", "minimum": 1 }
          },
          "required": ["component"]
        },
        "data": {
          "type": "object",
          "description": "事件相关的数据",
          "additionalProperties": true
        }
      },
      "required": ["type", "name", "category", "source"]
    },
    "performance_metrics": {
      "type": "object",
      "properties": {
        "execution_time": {
          "type": "object",
          "properties": {
            "start_time": { "$ref": "#/$defs/timestamp" },
            "end_time": { "$ref": "#/$defs/timestamp" },
            "duration_ms": { "type": "number", "minimum": 0 },
            "cpu_time_ms": { "type": "number", "minimum": 0 }
          },
          "required": ["start_time", "duration_ms"]
        },
        "resource_usage": {
          "type": "object",
          "properties": {
            "memory": {
              "type": "object",
              "properties": {
                "peak_usage_mb": { "type": "number", "minimum": 0 },
                "average_usage_mb": { "type": "number", "minimum": 0 },
                "allocations": { "type": "integer", "minimum": 0 },
                "deallocations": { "type": "integer", "minimum": 0 }
              }
            },
            "cpu": {
              "type": "object",
              "properties": {
                "utilization_percent": { "type": "number", "minimum": 0, "maximum": 100 },
                "instructions": { "type": "integer", "minimum": 0 },
                "cache_misses": { "type": "integer", "minimum": 0 }
              }
            },
            "network": {
              "type": "object",
              "properties": {
                "bytes_sent": { "type": "integer", "minimum": 0 },
                "bytes_received": { "type": "integer", "minimum": 0 },
                "requests_count": { "type": "integer", "minimum": 0 },
                "error_count": { "type": "integer", "minimum": 0 }
              }
            },
            "storage": {
              "type": "object",
              "properties": {
                "reads": { "type": "integer", "minimum": 0 },
                "writes": { "type": "integer", "minimum": 0 },
                "bytes_read": { "type": "integer", "minimum": 0 },
                "bytes_written": { "type": "integer", "minimum": 0 }
              }
            }
          }
        },
        "custom_metrics": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "value": { "type": ["number", "string", "boolean"] },
              "unit": { "type": "string" },
              "type": { "type": "string", "enum": ["counter", "gauge", "histogram", "summary"] }
            },
            "required": ["value", "type"]
          }
        }
      }
    },
    "context_snapshot": {
      "type": "object",
      "properties": {
        "variables": {
          "type": "object",
          "description": "执行时的变量快照",
          "additionalProperties": true
        },
        "environment": {
          "type": "object",
          "properties": {
            "os": { "type": "string" },
            "platform": { "type": "string" },
            "runtime_version": { "type": "string" },
            "environment_variables": { "type": "object", "additionalProperties": { "type": "string" } }
          }
        },
        "call_stack": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "function": { "type": "string" },
              "file": { "type": "string" },
              "line": { "type": "integer", "minimum": 1 },
              "arguments": { "type": "object", "additionalProperties": true }
            },
            "required": ["function"]
          }
        }
      }
    },
    "error_information": {
      "type": "object",
      "properties": {
        "error_code": { "type": "string" },
        "error_message": { "type": "string", "maxLength": 1000 },
        "error_type": { "type": "string", "enum": ["system", "business", "validation", "network", "timeout", "security"] },
        "stack_trace": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "file": { "type": "string" },
              "function": { "type": "string" },
              "line": { "type": "integer", "minimum": 1 },
              "column": { "type": "integer", "minimum": 1 }
            },
            "required": ["file", "function", "line"]
          }
        },
        "recovery_actions": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "action": { "type": "string", "enum": ["retry", "fallback", "escalate", "ignore", "abort"] },
              "description": { "type": "string" },
              "parameters": { "type": "object", "additionalProperties": true }
            },
            "required": ["action", "description"]
          }
        }
      },
      "required": ["error_code", "error_message", "error_type"]
    },
    "decision_log": {
      "type": "object",
      "properties": {
        "decision_point": { "type": "string" },
        "options_considered": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "option": { "type": "string" },
              "score": { "type": "number", "minimum": 0, "maximum": 1 },
              "rationale": { "type": "string" },
              "risk_factors": { "type": "array", "items": { "type": "string" } }
            },
            "required": ["option", "score"]
          }
        },
        "selected_option": { "type": "string" },
        "decision_criteria": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "criterion": { "type": "string" },
              "weight": { "type": "number", "minimum": 0, "maximum": 1 },
              "evaluation": { "type": "string" }
            },
            "required": ["criterion", "weight"]
          }
        },
        "confidence_level": { "type": "number", "minimum": 0, "maximum": 1 }
      },
      "required": ["decision_point", "options_considered", "selected_option"]
    },
    "correlations": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "correlation_id": { "$ref": "#/$defs/uuid" },
          "type": { "type": "string", "enum": ["causation", "temporal", "spatial", "logical"] },
          "related_trace_id": { "$ref": "#/$defs/uuid" },
          "strength": { "type": "number", "minimum": 0, "maximum": 1 },
          "description": { "type": "string" }
        },
        "required": ["correlation_id", "type", "related_trace_id"]
      }
    }
  },
  "required": [
    "protocol_version",
    "timestamp",
    "trace_id",
    "context_id",
    "trace_type",
    "severity",
    "event"
  ],
  "additionalProperties": false
}