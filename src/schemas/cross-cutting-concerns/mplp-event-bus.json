{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mplp.dev/schemas/v1.0/mplp-event-bus.json",
  "title": "MPLP Event Bus Protocol v1.0",
  "description": "多智能体协议生命周期平台模块间事件总线通信协议Schema",
  
  "type": "object",
  "$defs": {
    "uuid": {
      "type": "string",
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$",
      "description": "UUID v4 format"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp"
    },
    "module_type": {
      "type": "string",
      "enum": ["core", "context", "plan", "confirm", "trace", "role", "extension", "collab", "dialog", "network"],
      "description": "MPLP模块类型"
    },
    "event_type": {
      "type": "string",
      "enum": [
        "module_lifecycle",
        "coordination_request",
        "coordination_response", 
        "workflow_status",
        "transaction_event",
        "error_event",
        "performance_metrics",
        "security_event",
        "custom_event"
      ],
      "description": "事件类型分类"
    },
    "priority": {
      "type": "string",
      "enum": ["low", "normal", "high", "urgent", "critical"],
      "default": "normal",
      "description": "事件优先级"
    },
    "delivery_mode": {
      "type": "string",
      "enum": ["fire_and_forget", "at_least_once", "exactly_once"],
      "default": "at_least_once",
      "description": "事件投递模式"
    },
    "routing_strategy": {
      "type": "string",
      "enum": ["direct", "topic", "fanout", "headers"],
      "default": "topic",
      "description": "路由策略"
    },
    "event_message": {
      "type": "object",
      "properties": {
        "event_id": {"$ref": "#/$defs/uuid"},
        "event_type": {"$ref": "#/$defs/event_type"},
        "event_name": {
          "type": "string",
          "description": "具体事件名称"
        },
        "source_module": {"$ref": "#/$defs/module_type"},
        "target_modules": {
          "type": "array",
          "items": {"$ref": "#/$defs/module_type"},
          "description": "目标模块列表，空数组表示广播"
        },
        "payload": {
          "type": "object",
          "description": "事件数据载荷"
        },
        "routing_key": {
          "type": "string",
          "description": "路由键，用于topic路由"
        },
        "headers": {
          "type": "object",
          "description": "事件头部信息"
        },
        "priority": {"$ref": "#/$defs/priority"},
        "delivery_mode": {"$ref": "#/$defs/delivery_mode"},
        "ttl_ms": {
          "type": "integer",
          "minimum": 1000,
          "maximum": 86400000,
          "default": 300000,
          "description": "事件生存时间(毫秒)"
        },
        "correlation_id": {
          "$ref": "#/$defs/uuid",
          "description": "关联ID，用于追踪相关事件"
        },
        "reply_to": {
          "type": "string",
          "description": "回复地址"
        },
        "trace_context": {
          "type": "object",
          "properties": {
            "trace_id": {"$ref": "#/$defs/uuid"},
            "span_id": {"$ref": "#/$defs/uuid"},
            "parent_span_id": {"$ref": "#/$defs/uuid"}
          },
          "description": "分布式追踪上下文"
        },
        "created_at": {"$ref": "#/$defs/timestamp"},
        "expires_at": {"$ref": "#/$defs/timestamp"}
      ,
    "event_bus_details": {
      "type": "object",
      "properties": {
        "bus_topology": {
          "type": "string",
          "enum": [
            "hub",
            "mesh",
            "tree"
          ]
        },
        "message_ordering": {
          "type": "string",
          "enum": [
            "fifo",
            "priority",
            "timestamp"
          ]
        },
        "delivery_guarantee": {
          "type": "string",
          "enum": [
            "at_most_once",
            "at_least_once",
            "exactly_once"
          ]
        }
      }
    }
  },
  "required": ["event_id", "event_type", "event_name", "source_module", "payload", "created_at"]
    },
    "event_subscription": {
      "type": "object",
      "properties": {
        "subscription_id": {"$ref": "#/$defs/uuid"},
        "subscriber_module": {"$ref": "#/$defs/module_type"},
        "event_patterns": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "event_type": {"$ref": "#/$defs/event_type"},
              "event_name_pattern": {
                "type": "string",
                "description": "事件名称匹配模式，支持通配符"
              },
              "source_modules": {
                "type": "array",
                "items": {"$ref": "#/$defs/module_type"},
                "description": "关注的源模块列表"
              },
              "routing_key_pattern": {
                "type": "string",
                "description": "路由键匹配模式"
              },
              "filter_conditions": {
                "type": "object",
                "description": "事件过滤条件"
              }
            },
            "required": ["event_type"]
          },
          "minItems": 1
        },
        "delivery_options": {
          "type": "object",
          "properties": {
            "max_retry_count": {
              "type": "integer",
              "minimum": 0,
              "maximum": 10,
              "default": 3
            },
            "retry_delay_ms": {
              "type": "integer",
              "minimum": 100,
              "default": 1000
            },
            "dead_letter_enabled": {
              "type": "boolean",
              "default": true
            },
            "batch_size": {
              "type": "integer",
              "minimum": 1,
              "maximum": 1000,
              "default": 1
            },
            "batch_timeout_ms": {
              "type": "integer",
              "minimum": 100,
              "default": 5000
            }
          }
        },
        "active": {
          "type": "boolean",
          "default": true,
          "description": "订阅是否激活"
        },
        "created_at": {"$ref": "#/$defs/timestamp"},
        "updated_at": {"$ref": "#/$defs/timestamp"}
      },
      "required": ["subscription_id", "subscriber_module", "event_patterns", "created_at"]
    },
    "event_delivery_receipt": {
      "type": "object",
      "properties": {
        "receipt_id": {"$ref": "#/$defs/uuid"},
        "event_id": {"$ref": "#/$defs/uuid"},
        "subscription_id": {"$ref": "#/$defs/uuid"},
        "delivery_status": {
          "type": "string",
          "enum": ["delivered", "failed", "rejected", "timeout", "dead_letter"],
          "description": "投递状态"
        },
        "delivery_attempt": {
          "type": "integer",
          "minimum": 1,
          "description": "投递尝试次数"
        },
        "processing_time_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "处理时间(毫秒)"
        },
        "error_info": {
          "type": "object",
          "properties": {
            "error_code": {
              "type": "string",
              "pattern": "^[A-Z]{4}[0-9]{4}$"
            },
            "error_message": {"type": "string"},
            "error_details": {"type": "object"}
          }
        },
        "delivered_at": {"$ref": "#/$defs/timestamp"}
      },
      "required": ["receipt_id", "event_id", "subscription_id", "delivery_status", "delivery_attempt", "delivered_at"]
    },
    "event_bus_metrics": {
      "type": "object",
      "properties": {
        "metric_id": {"$ref": "#/$defs/uuid"},
        "time_window_start": {"$ref": "#/$defs/timestamp"},
        "time_window_end": {"$ref": "#/$defs/timestamp"},
        "throughput_metrics": {
          "type": "object",
          "properties": {
            "events_published": {"type": "integer"},
            "events_delivered": {"type": "integer"},
            "events_failed": {"type": "integer"},
            "average_latency_ms": {"type": "number"},
            "p95_latency_ms": {"type": "number"},
            "p99_latency_ms": {"type": "number"}
          }
        },
        "resource_metrics": {
          "type": "object",
          "properties": {
            "memory_usage_mb": {"type": "number"},
            "cpu_usage_percent": {"type": "number"},
            "network_io_mb": {"type": "number"},
            "queue_depth": {"type": "integer"}
          }
        },
        "error_metrics": {
          "type": "object",
          "properties": {
            "error_rate": {"type": "number"},
            "timeout_rate": {"type": "number"},
            "dead_letter_rate": {"type": "number"}
          }
        }
      },
      "required": ["metric_id", "time_window_start", "time_window_end"]
    }
  },
  "properties": {
    "protocol_version": {
      "type": "string",
      "const": "1.0.0",
      "description": "MPLP协议版本"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601格式时间戳"
    },
    "event_message": {"$ref": "#/$defs/event_message"},
    "event_subscription": {"$ref": "#/$defs/event_subscription"},
    "event_delivery_receipt": {"$ref": "#/$defs/event_delivery_receipt"},
    "event_bus_metrics": {"$ref": "#/$defs/event_bus_metrics"},
    "audit_trail": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },
        "retention_days": { "type": "integer", "minimum": 1, "maximum": 2555 },
        "audit_events": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "event_id": { "$ref": "#/$defs/uuid" },
              "event_type": {
                "type": "string",
                "enum": ["event_published", "event_delivered", "event_failed", "subscription_created", "subscription_removed", "queue_created", "queue_purged", "dead_letter_moved"]
              },
              "timestamp": { "$ref": "#/$defs/timestamp" },
              "user_id": { "type": "string" },
              "user_role": { "type": "string" },
              "action": { "type": "string" },
              "resource": { "type": "string" },
              "event_bus_operation": { "type": "string" },
              "message_id": { "$ref": "#/$defs/uuid" },
              "topic_name": { "type": "string" },
              "subscriber_id": { "$ref": "#/$defs/uuid" },
              "delivery_details": { "type": "object" },
              "ip_address": { "type": "string" },
              "user_agent": { "type": "string" },
              "session_id": { "type": "string" },
              "correlation_id": { "$ref": "#/$defs/uuid" }
            },
            "required": ["event_id", "event_type", "timestamp", "user_id", "action", "resource"]
          }
        },
        "compliance_settings": {
          "type": "object",
          "properties": {
            "gdpr_enabled": { "type": "boolean" },
            "hipaa_enabled": { "type": "boolean" },
            "sox_enabled": { "type": "boolean" },
            "event_audit_level": {
              "type": "string",
              "enum": ["basic", "detailed", "comprehensive"]
            },
            "message_content_logging": { "type": "boolean" },
            "custom_compliance": {
              "type": "array",
              "items": { "type": "string" }
            }
          }
        }
      },
      "required": ["enabled", "retention_days"]
    },
    "monitoring_integration": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },
        "supported_providers": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["prometheus", "grafana", "datadog", "new_relic", "elastic_apm", "custom"]
          }
        },
        "integration_endpoints": {
          "type": "object",
          "properties": {
            "metrics_api": { "type": "string", "format": "uri" },
            "event_throughput_api": { "type": "string", "format": "uri" },
            "message_latency_api": { "type": "string", "format": "uri" },
            "queue_status_api": { "type": "string", "format": "uri" }
          }
        },
        "event_bus_metrics": {
          "type": "object",
          "properties": {
            "track_event_throughput": { "type": "boolean" },
            "track_message_latency": { "type": "boolean" },
            "track_queue_status": { "type": "boolean" },
            "track_subscription_health": { "type": "boolean" }
          }
        },
        "export_formats": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["prometheus", "opentelemetry", "custom"]
          }
        }
      },
      "required": ["enabled", "supported_providers"]
    },
    "performance_metrics": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },
        "collection_interval_seconds": { "type": "integer", "minimum": 10, "maximum": 3600 },
        "metrics": {
          "type": "object",
          "properties": {
            "event_throughput_per_second": { "type": "number", "minimum": 0 },
            "message_latency_ms": { "type": "number", "minimum": 0 },
            "queue_depth_count": { "type": "integer", "minimum": 0 },
            "delivery_success_rate_percent": { "type": "number", "minimum": 0, "maximum": 100 },
            "subscription_health_score": { "type": "number", "minimum": 0, "maximum": 10 },
            "active_subscribers_count": { "type": "integer", "minimum": 0 },
            "failed_deliveries_count": { "type": "integer", "minimum": 0 },
            "dead_letter_queue_size": { "type": "integer", "minimum": 0 },
            "average_processing_time_ms": { "type": "number", "minimum": 0 }
          }
        },
        "health_status": {
          "type": "object",
          "properties": {
            "status": {
              "type": "string",
              "enum": ["healthy", "degraded", "unhealthy", "overloaded"]
            },
            "last_check": { "$ref": "#/$defs/timestamp" },
            "checks": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "check_name": { "type": "string" },
                  "status": {
                    "type": "string",
                    "enum": ["pass", "fail", "warn"]
                  },
                  "message": { "type": "string" },
                  "duration_ms": { "type": "number", "minimum": 0 }
                },
                "required": ["check_name", "status"]
              }
            }
          }
        },
        "alerting": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean" },
            "thresholds": {
              "type": "object",
              "properties": {
                "min_throughput_per_second": { "type": "number", "minimum": 0 },
                "max_message_latency_ms": { "type": "number", "minimum": 0 },
                "max_queue_depth_count": { "type": "integer", "minimum": 0 },
                "min_delivery_success_rate_percent": { "type": "number", "minimum": 0, "maximum": 100 },
                "max_dead_letter_queue_size": { "type": "integer", "minimum": 0 }
              }
            },
            "notification_channels": {
              "type": "array",
              "items": {
                "type": "string",
                "enum": ["email", "slack", "webhook", "sms", "pagerduty"]
              }
            }
          }
        }
      },
      "required": ["enabled", "collection_interval_seconds"]
    },
    "version_history": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },
        "max_versions": { "type": "integer", "minimum": 1, "maximum": 100, "default": 50 },
        "versions": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "version_id": { "$ref": "#/$defs/uuid" },
              "version_number": { "type": "integer", "minimum": 1 },
              "created_at": { "$ref": "#/$defs/timestamp" },
              "created_by": { "type": "string" },
              "change_summary": { "type": "string" },
              "event_bus_snapshot": { "type": "object" },
              "change_type": {
                "type": "string",
                "enum": ["bus_created", "configuration_updated", "topics_added", "topics_removed", "subscriptions_modified"]
              }
            },
            "required": ["version_id", "version_number", "created_at", "created_by", "change_type"]
          }
        },
        "auto_versioning": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean" },
            "version_on_config_change": { "type": "boolean" },
            "version_on_topic_change": { "type": "boolean" },
            "version_on_subscription_change": { "type": "boolean" }
          }
        }
      },
      "required": ["enabled", "max_versions"]
    },
    "search_metadata": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },
        "indexing_strategy": {
          "type": "string",
          "enum": ["full_text", "keyword", "semantic", "hybrid"]
        },
        "searchable_fields": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["message_id", "topic_name", "event_type", "subscriber_id", "message_content", "performance_metrics", "metadata", "audit_logs"]
          }
        },
        "search_indexes": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "index_id": { "type": "string" },
              "index_name": { "type": "string" },
              "fields": { "type": "array", "items": { "type": "string" } },
              "index_type": {
                "type": "string",
                "enum": ["btree", "hash", "gin", "gist", "full_text"]
              },
              "created_at": { "$ref": "#/$defs/timestamp" },
              "last_updated": { "$ref": "#/$defs/timestamp" }
            },
            "required": ["index_id", "index_name", "fields", "index_type"]
          }
        },
        "event_indexing": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean" },
            "index_message_content": { "type": "boolean" },
            "index_performance_metrics": { "type": "boolean" },
            "index_audit_logs": { "type": "boolean" }
          }
        },
        "auto_indexing": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean" },
            "index_new_events": { "type": "boolean" },
            "reindex_interval_hours": { "type": "integer", "minimum": 1 }
          }
        }
      },
      "required": ["enabled", "indexing_strategy"]
    },
    "event_bus_details": {
      "type": "object",
      "properties": {
        "bus_topology": { "type": "string", "enum": ["hub", "mesh", "tree"] },
        "message_ordering": { "type": "string", "enum": ["fifo", "priority", "timestamp"] },
        "delivery_guarantee": { "type": "string", "enum": ["at_most_once", "at_least_once", "exactly_once"] }
      },
      "description": "事件总线详细配置"
    },

    "event_bus_operation": {

      "type": "string",

      "enum": [

        "publish",

        "subscribe",

        "unsubscribe",

        "route",

        "filter"

      ],

      "description": "事件总线操作类型"

    },


    "event_bus_operation": {


      "type": "string",


      "enum": [


        "publish",


        "subscribe",


        "unsubscribe",


        "route",


        "filter"


      ],


      "description": "事件总线操作类型"


    },
    "event_integration": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },
        "event_bus_connection": {
          "type": "object",
          "properties": {
            "bus_type": {
              "type": "string",
              "enum": ["kafka", "rabbitmq", "redis", "nats", "custom"]
            },
            "connection_string": { "type": "string" },
            "topic_prefix": { "type": "string" },
            "consumer_group": { "type": "string" }
          }
        },
        "published_events": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["eventbus_message_published", "eventbus_message_delivered", "eventbus_message_failed", "eventbus_subscription_created", "eventbus_queue_overloaded", "eventbus_dead_letter_moved"]
          }
        },
        "subscribed_events": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["context_updated", "plan_executed", "confirm_approved", "trace_completed", "role_assigned", "extension_activated", "dialog_started", "network_connected", "collab_coordinated", "orchestration_executed", "coordination_synchronized"]
          }
        },
        "event_routing": {
          "type": "object",
          "properties": {
            "routing_rules": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "rule_id": { "type": "string" },
                  "condition": { "type": "string" },
                  "target_topic": { "type": "string" },
                  "enabled": { "type": "boolean" }
                },
                "required": ["rule_id", "condition", "target_topic"]
              }
            }
          }
        }
      },
      "required": ["enabled"]
    }
  },
  "oneOf": [
    {"required": ["protocol_version", "timestamp", "event_message", "audit_trail", "monitoring_integration", "performance_metrics", "version_history", "search_metadata", "event_bus_details", "event_integration"]},
    {"required": ["protocol_version", "timestamp", "event_subscription", "audit_trail", "monitoring_integration", "performance_metrics", "version_history", "search_metadata", "event_bus_details", "event_integration"]},
    {"required": ["protocol_version", "timestamp", "event_delivery_receipt", "audit_trail", "monitoring_integration", "performance_metrics", "version_history", "search_metadata", "event_bus_details", "event_integration"]},
    {"required": ["protocol_version", "timestamp", "event_bus_metrics", "audit_trail", "monitoring_integration", "performance_metrics", "version_history", "search_metadata", "event_bus_details", "event_integration"]}
  ]
}
