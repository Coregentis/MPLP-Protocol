{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mplp.dev/schemas/v1.0/mplp-error-handling.json",
  "title": "MPLP Error Handling Protocol v1.0",
  "description": "多智能体协议生命周期平台统一错误处理和异常传播协议Schema v1.0.0",
  "type": "object",
  "$defs": {
    "uuid": {
      "type": "string",
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$",
      "description": "UUID v4 format"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp"
    },
    "module_type": {
      "type": "string",
      "enum": ["core", "context", "plan", "confirm", "trace", "role", "extension", "collab", "dialog", "network", "coordination", "orchestration", "transaction", "event_bus", "state_sync"],
      "description": "MPLP模块类型"
    },
    "error_code": {
      "type": "string",
      "pattern": "^[A-Z]{4}[0-9]{4}$",
      "description": "标准化错误代码格式: ABCD1234"
    },
    "error_category": {
      "type": "string",
      "enum": ["validation", "authentication", "authorization", "resource", "network", "timeout", "conflict", "system", "business", "integration"],
      "description": "错误分类"
    },
    "error_severity": {
      "type": "string",
      "enum": ["low", "medium", "high", "critical", "fatal"],
      "description": "错误严重程度"
    },
    "recovery_strategy": {
      "type": "string",
      "enum": ["retry", "fallback", "compensate", "escalate", "ignore", "manual"],
      "description": "恢复策略"
    },
    "stack_frame": {
      "type": "object",
      "properties": {
        "module": {"$ref": "#/$defs/module_type"},
        "function_name": {"type": "string"},
        "file_path": {"type": "string"},
        "line_number": {"type": "integer", "minimum": 1},
        "column_number": {"type": "integer", "minimum": 1},
        "source_code": {"type": "string"}
      ,
    "error_handling_operation": {
      "type": "string",
      "enum": [
        "capture",
        "analyze",
        "recover",
        "escalate",
        "report"
      ]
    },
    "error_handling_details": {
      "type": "object",
      "properties": {
        "error_category": {
          "type": "string"
        },
        "recovery_strategy": {
          "type": "string"
        },
        "escalation_level": {
          "type": "integer",
          "minimum": 1,
          "maximum": 5
        }
      }
    }
  },
  "required": ["module", "function_name"]
    },
    "error_context": {
      "type": "object",
      "properties": {
        "request_id": {"$ref": "#/$defs/uuid"},
        "session_id": {"$ref": "#/$defs/uuid"},
        "user_id": {"type": "string"},
        "operation": {"type": "string"},
        "input_parameters": {"type": "object"},
        "environment": {
          "type": "string",
          "enum": ["development", "testing", "staging", "production"]
        },
        "system_state": {"type": "object"},
        "correlation_data": {"type": "object"}
      }
    },
    "error_info": {
      "type": "object",
      "properties": {
        "error_id": {"$ref": "#/$defs/uuid"},
        "error_code": {"$ref": "#/$defs/error_code"},
        "error_category": {"$ref": "#/$defs/error_category"},
        "error_severity": {"$ref": "#/$defs/error_severity"},
        "error_message": {
          "type": "string",
          "description": "用户友好的错误消息"
        },
        "technical_message": {
          "type": "string",
          "description": "技术详细错误信息"
        },
        "error_details": {
          "type": "object",
          "description": "详细错误数据"
        },
        "source_module": {"$ref": "#/$defs/module_type"},
        "source_function": {"type": "string"},
        "stack_trace": {
          "type": "array",
          "items": {"$ref": "#/$defs/stack_frame"},
          "description": "错误堆栈追踪"
        },
        "inner_errors": {
          "type": "array",
          "items": {"$ref": "#/$defs/error_info"},
          "description": "内部错误链"
        },
        "context": {"$ref": "#/$defs/error_context"},
        "recovery_suggestions": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "strategy": {"$ref": "#/$defs/recovery_strategy"},
              "description": {"type": "string"},
              "automated": {"type": "boolean"},
              "success_probability": {
                "type": "number",
                "minimum": 0.0,
                "maximum": 1.0
              }
            },
            "required": ["strategy", "description"]
          }
        },
        "occurred_at": {"$ref": "#/$defs/timestamp"},
        "resolved_at": {"$ref": "#/$defs/timestamp"},
        "resolution_notes": {"type": "string"}
      },
      "required": ["error_id", "error_code", "error_category", "error_severity", "error_message", "source_module", "occurred_at"]
    },
    "error_propagation": {
      "type": "object",
      "properties": {
        "propagation_id": {"$ref": "#/$defs/uuid"},
        "original_error": {"$ref": "#/$defs/error_info"},
        "propagation_chain": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "module": {"$ref": "#/$defs/module_type"},
              "function": {"type": "string"},
              "transformation": {
                "type": "string",
                "enum": ["wrapped", "translated", "enriched", "filtered", "aggregated"]
              },
              "added_context": {"type": "object"},
              "timestamp": {"$ref": "#/$defs/timestamp"}
            },
            "required": ["module", "function", "transformation", "timestamp"]
          }
        },
        "final_error": {"$ref": "#/$defs/error_info"},
        "propagation_rules": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "rule_name": {"type": "string"},
              "condition": {"type": "string"},
              "action": {
                "type": "string",
                "enum": ["propagate", "suppress", "transform", "log_only"]
              },
              "transformation_template": {"type": "string"}
            },
            "required": ["rule_name", "condition", "action"]
          }
        }
      },
      "required": ["propagation_id", "original_error", "propagation_chain", "final_error"]
    },
    "error_recovery": {
      "type": "object",
      "properties": {
        "recovery_id": {"$ref": "#/$defs/uuid"},
        "error_id": {"$ref": "#/$defs/uuid"},
        "recovery_strategy": {"$ref": "#/$defs/recovery_strategy"},
        "recovery_attempts": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "attempt_number": {"type": "integer", "minimum": 1},
              "strategy_used": {"$ref": "#/$defs/recovery_strategy"},
              "attempt_timestamp": {"$ref": "#/$defs/timestamp"},
              "success": {"type": "boolean"},
              "duration_ms": {"type": "integer", "minimum": 0},
              "result_data": {"type": "object"},
              "failure_reason": {"type": "string"}
            },
            "required": ["attempt_number", "strategy_used", "attempt_timestamp", "success"]
          }
        },
        "final_outcome": {
          "type": "string",
          "enum": ["recovered", "failed", "escalated", "manual_intervention_required"]
        },
        "recovery_metadata": {
          "type": "object",
          "properties": {
            "total_attempts": {"type": "integer"},
            "total_duration_ms": {"type": "integer"},
            "resources_consumed": {"type": "object"},
            "side_effects": {
              "type": "array",
              "items": {"type": "string"}
            }
          }
        },
        "completed_at": {"$ref": "#/$defs/timestamp"}
      },
      "required": ["recovery_id", "error_id", "recovery_strategy", "recovery_attempts", "final_outcome"]
    },
    "error_monitoring": {
      "type": "object",
      "properties": {
        "monitoring_id": {"$ref": "#/$defs/uuid"},
        "time_window": {
          "type": "object",
          "properties": {
            "start_time": {"$ref": "#/$defs/timestamp"},
            "end_time": {"$ref": "#/$defs/timestamp"},
            "duration_ms": {"type": "integer", "minimum": 1}
          },
          "required": ["start_time", "end_time", "duration_ms"]
        },
        "error_statistics": {
          "type": "object",
          "properties": {
            "total_errors": {"type": "integer", "minimum": 0},
            "errors_by_category": {
              "type": "object",
              "additionalProperties": {"type": "integer"}
            },
            "errors_by_severity": {
              "type": "object",
              "additionalProperties": {"type": "integer"}
            },
            "errors_by_module": {
              "type": "object",
              "additionalProperties": {"type": "integer"}
            },
            "error_rate": {
              "type": "number",
              "minimum": 0.0,
              "description": "每秒错误数"
            },
            "recovery_success_rate": {
              "type": "number",
              "minimum": 0.0,
              "maximum": 1.0
            }
          }
        },
        "trending_data": {
          "type": "object",
          "properties": {
            "error_trend": {
              "type": "string",
              "enum": ["increasing", "decreasing", "stable", "volatile"]
            },
            "trend_confidence": {
              "type": "number",
              "minimum": 0.0,
              "maximum": 1.0
            },
            "predicted_next_hour": {"type": "integer"},
            "anomaly_detected": {"type": "boolean"},
            "anomaly_description": {"type": "string"}
          }
        },
        "alert_thresholds": {
          "type": "object",
          "properties": {
            "error_rate_threshold": {"type": "number"},
            "critical_error_threshold": {"type": "integer"},
            "recovery_failure_threshold": {"type": "number"}
          }
        }
      },
      "required": ["monitoring_id", "time_window", "error_statistics"]
    },
    "error_notification": {
      "type": "object",
      "properties": {
        "notification_id": {"$ref": "#/$defs/uuid"},
        "error_id": {"$ref": "#/$defs/uuid"},
        "notification_type": {
          "type": "string",
          "enum": ["immediate", "batched", "digest", "escalation"]
        },
        "recipients": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "recipient_type": {
                "type": "string",
                "enum": ["user", "team", "system", "external_service"]
              },
              "recipient_id": {"type": "string"},
              "notification_method": {
                "type": "string",
                "enum": ["email", "sms", "webhook", "dashboard", "log"]
              },
              "priority": {
                "type": "string",
                "enum": ["low", "normal", "high", "urgent"]
              }
            },
            "required": ["recipient_type", "recipient_id", "notification_method"]
          }
        },
        "notification_content": {
          "type": "object",
          "properties": {
            "subject": {"type": "string"},
            "summary": {"type": "string"},
            "detailed_message": {"type": "string"},
            "action_items": {
              "type": "array",
              "items": {"type": "string"}
            },
            "attachments": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "name": {"type": "string"},
                  "type": {"type": "string"},
                  "content": {"type": "string"}
                },
                "required": ["name", "type", "content"]
              }
            }
          }
        },
        "delivery_status": {
          "type": "object",
          "properties": {
            "sent_at": {"$ref": "#/$defs/timestamp"},
            "delivery_attempts": {"type": "integer"},
            "successful_deliveries": {"type": "integer"},
            "failed_deliveries": {"type": "integer"},
            "delivery_errors": {
              "type": "array",
              "items": {"type": "string"}
            }
          }
        }
      },
      "required": ["notification_id", "error_id", "notification_type", "recipients", "notification_content"]
    }
  },
  "properties": {
    "protocol_version": {
      "type": "string",
      "const": "1.0.0",
      "description": "MPLP协议版本"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601格式时间戳"
    },
    "error_info": {"$ref": "#/$defs/error_info"},
    "error_propagation": {"$ref": "#/$defs/error_propagation"},
    "error_recovery": {"$ref": "#/$defs/error_recovery"},
    "error_monitoring": {"$ref": "#/$defs/error_monitoring"},
    "error_notification": {"$ref": "#/$defs/error_notification"},
    "audit_trail": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },
        "retention_days": { "type": "integer", "minimum": 1, "maximum": 2555 },
        "audit_events": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "event_id": { "$ref": "#/$defs/uuid" },
              "event_type": {
                "type": "string",
                "enum": ["error_occurred", "error_handled", "error_recovered", "error_escalated", "error_ignored", "recovery_attempted", "fallback_executed", "error_pattern_detected"]
              },
              "timestamp": { "$ref": "#/$defs/timestamp" },
              "user_id": { "type": "string" },
              "user_role": { "type": "string" },
              "action": { "type": "string" },
              "resource": { "type": "string" },
              "error_operation": { "type": "string" },
              "error_code": { "$ref": "#/$defs/error_code" },
              "error_category": { "$ref": "#/$defs/error_category" },
              "error_severity": { "$ref": "#/$defs/error_severity" },
              "source_module": { "$ref": "#/$defs/module_type" },
              "recovery_strategy": { "$ref": "#/$defs/recovery_strategy" },
              "error_details": { "type": "object" },
              "ip_address": { "type": "string" },
              "user_agent": { "type": "string" },
              "session_id": { "type": "string" },
              "correlation_id": { "$ref": "#/$defs/uuid" }
            },
            "required": ["event_id", "event_type", "timestamp", "user_id", "action", "resource"]
          }
        },
        "compliance_settings": {
          "type": "object",
          "properties": {
            "gdpr_enabled": { "type": "boolean" },
            "hipaa_enabled": { "type": "boolean" },
            "sox_enabled": { "type": "boolean" },
            "error_audit_level": {
              "type": "string",
              "enum": ["basic", "detailed", "comprehensive"]
            },
            "error_data_logging": { "type": "boolean" },
            "custom_compliance": {
              "type": "array",
              "items": { "type": "string" }
            }
          }
        }
      },
      "required": ["enabled", "retention_days"]
    },
    "monitoring_integration": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },
        "supported_providers": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["prometheus", "grafana", "datadog", "new_relic", "elastic_apm", "custom"]
          }
        },
        "integration_endpoints": {
          "type": "object",
          "properties": {
            "metrics_api": { "type": "string", "format": "uri" },
            "error_handling_api": { "type": "string", "format": "uri" },
            "exception_analysis_api": { "type": "string", "format": "uri" },
            "system_stability_api": { "type": "string", "format": "uri" }
          }
        },
        "error_metrics": {
          "type": "object",
          "properties": {
            "track_error_handling": { "type": "boolean" },
            "track_exception_analysis": { "type": "boolean" },
            "track_system_stability": { "type": "boolean" },
            "track_recovery_success": { "type": "boolean" }
          }
        },
        "export_formats": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["prometheus", "opentelemetry", "custom"]
          }
        }
      },
      "required": ["enabled", "supported_providers"]
    },
    "performance_metrics": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },
        "collection_interval_seconds": { "type": "integer", "minimum": 10, "maximum": 3600 },
        "metrics": {
          "type": "object",
          "properties": {
            "error_handling_latency_ms": { "type": "number", "minimum": 0 },
            "error_frequency_per_hour": { "type": "number", "minimum": 0 },
            "recovery_success_rate_percent": { "type": "number", "minimum": 0, "maximum": 100 },
            "system_stability_score": { "type": "number", "minimum": 0, "maximum": 10 },
            "exception_analysis_accuracy_percent": { "type": "number", "minimum": 0, "maximum": 100 },
            "active_errors_count": { "type": "integer", "minimum": 0 },
            "critical_errors_count": { "type": "integer", "minimum": 0 },
            "escalation_frequency_percent": { "type": "number", "minimum": 0, "maximum": 100 },
            "average_recovery_time_ms": { "type": "number", "minimum": 0 }
          }
        },
        "health_status": {
          "type": "object",
          "properties": {
            "status": {
              "type": "string",
              "enum": ["healthy", "degraded", "unhealthy", "critical"]
            },
            "last_check": { "$ref": "#/$defs/timestamp" },
            "checks": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "check_name": { "type": "string" },
                  "status": {
                    "type": "string",
                    "enum": ["pass", "fail", "warn"]
                  },
                  "message": { "type": "string" },
                  "duration_ms": { "type": "number", "minimum": 0 }
                },
                "required": ["check_name", "status"]
              }
            }
          }
        },
        "alerting": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean" },
            "thresholds": {
              "type": "object",
              "properties": {
                "max_error_handling_latency_ms": { "type": "number", "minimum": 0 },
                "max_error_frequency_per_hour": { "type": "number", "minimum": 0 },
                "min_recovery_success_rate_percent": { "type": "number", "minimum": 0, "maximum": 100 },
                "min_system_stability_score": { "type": "number", "minimum": 0, "maximum": 10 },
                "max_critical_errors_count": { "type": "integer", "minimum": 0 }
              }
            },
            "notification_channels": {
              "type": "array",
              "items": {
                "type": "string",
                "enum": ["email", "slack", "webhook", "sms", "pagerduty"]
              }
            }
          }
        }
      },
      "required": ["enabled", "collection_interval_seconds"]
    },
    "version_history": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },
        "max_versions": { "type": "integer", "minimum": 1, "maximum": 100, "default": 50 },
        "versions": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "version_id": { "$ref": "#/$defs/uuid" },
              "version_number": { "type": "integer", "minimum": 1 },
              "created_at": { "$ref": "#/$defs/timestamp" },
              "created_by": { "type": "string" },
              "change_summary": { "type": "string" },
              "error_handling_snapshot": { "type": "object" },
              "change_type": {
                "type": "string",
                "enum": ["error_handler_created", "configuration_updated", "recovery_strategy_changed", "error_patterns_modified", "notification_rules_updated"]
              }
            },
            "required": ["version_id", "version_number", "created_at", "created_by", "change_type"]
          }
        },
        "auto_versioning": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean" },
            "version_on_config_change": { "type": "boolean" },
            "version_on_strategy_change": { "type": "boolean" },
            "version_on_pattern_change": { "type": "boolean" }
          }
        }
      },
      "required": ["enabled", "max_versions"]
    },
    "search_metadata": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },
        "indexing_strategy": {
          "type": "string",
          "enum": ["full_text", "keyword", "semantic", "hybrid"]
        },
        "searchable_fields": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["error_code", "error_category", "error_severity", "source_module", "error_message", "performance_metrics", "metadata", "audit_logs"]
          }
        },
        "search_indexes": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "index_id": { "type": "string" },
              "index_name": { "type": "string" },
              "fields": { "type": "array", "items": { "type": "string" } },
              "index_type": {
                "type": "string",
                "enum": ["btree", "hash", "gin", "gist", "full_text"]
              },
              "created_at": { "$ref": "#/$defs/timestamp" },
              "last_updated": { "$ref": "#/$defs/timestamp" }
            },
            "required": ["index_id", "index_name", "fields", "index_type"]
          }
        },
        "error_indexing": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean" },
            "index_error_data": { "type": "boolean" },
            "index_performance_metrics": { "type": "boolean" },
            "index_audit_logs": { "type": "boolean" }
          }
        },
        "auto_indexing": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean" },
            "index_new_errors": { "type": "boolean" },
            "reindex_interval_hours": { "type": "integer", "minimum": 1 }
          }
        }
      },
      "required": ["enabled", "indexing_strategy"]
    },
    "error_handling_operation": {
      "type": "string",
      "enum": ["capture", "analyze", "recover", "escalate", "report"],
      "description": "错误处理操作类型"
    },
    "error_handling_details": {
      "type": "object",
      "properties": {
        "error_category": { "type": "string" },
        "recovery_strategy": { "type": "string" },
        "escalation_level": { "type": "integer", "minimum": 1, "maximum": 5 }
      },
      "description": "错误处理详细信息"
    },
    "event_integration": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean" },
        "event_bus_connection": {
          "type": "object",
          "properties": {
            "bus_type": {
              "type": "string",
              "enum": ["kafka", "rabbitmq", "redis", "nats", "custom"]
            },
            "connection_string": { "type": "string" },
            "topic_prefix": { "type": "string" },
            "consumer_group": { "type": "string" }
          }
        },
        "published_events": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["error_handling_error_occurred", "error_handling_error_handled", "error_handling_error_recovered", "error_handling_error_escalated", "error_handling_recovery_attempted", "error_handling_fallback_executed", "error_handling_pattern_detected"]
          }
        },
        "subscribed_events": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["context_updated", "plan_executed", "confirm_approved", "trace_completed", "role_assigned", "extension_activated", "dialog_started", "network_connected", "collab_coordinated", "orchestration_executed", "coordination_synchronized", "eventbus_message_published", "statesync_sync_completed", "transaction_committed", "protocolversion_version_checked"]
          }
        },
        "event_routing": {
          "type": "object",
          "properties": {
            "routing_rules": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "rule_id": { "type": "string" },
                  "condition": { "type": "string" },
                  "target_topic": { "type": "string" },
                  "enabled": { "type": "boolean" }
                },
                "required": ["rule_id", "condition", "target_topic"]
              }
            }
          }
        }
      },
      "required": ["enabled"]
    }
  },
  "oneOf": [
    {"required": ["protocol_version", "timestamp", "error_info", "audit_trail", "monitoring_integration", "performance_metrics", "version_history", "search_metadata", "error_handling_operation", "error_handling_details", "event_integration"]},
    {"required": ["protocol_version", "timestamp", "error_propagation", "audit_trail", "monitoring_integration", "performance_metrics", "version_history", "search_metadata", "error_handling_operation", "error_handling_details", "event_integration"]},
    {"required": ["protocol_version", "timestamp", "error_recovery", "audit_trail", "monitoring_integration", "performance_metrics", "version_history", "search_metadata", "error_handling_operation", "error_handling_details", "event_integration"]},
    {"required": ["protocol_version", "timestamp", "error_monitoring", "audit_trail", "monitoring_integration", "performance_metrics", "version_history", "search_metadata", "error_handling_operation", "error_handling_details", "event_integration"]},
    {"required": ["protocol_version", "timestamp", "error_notification", "audit_trail", "monitoring_integration", "performance_metrics", "version_history", "search_metadata", "error_handling_operation", "error_handling_details", "event_integration"]}
  ]
}
