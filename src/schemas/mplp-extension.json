{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mplp.dev/schemas/v1.0/mplp-extension.json",
  "title": "MPLP Extension Protocol v1.0",
  "description": "Extension模块协议Schema - 扩展机制和插件管理",
  "type": "object",
  "$defs": {
    "uuid": {
      "type": "string",
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$",
      "description": "UUID v4格式的唯一标识符"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601格式的时间戳"
    },
    "version": {
      "type": "string",
      "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-((?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\\.(?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\\+([0-9a-zA-Z-]+(?:\\.[0-9a-zA-Z-]+)*))?$",
      "description": "语义化版本号 (SemVer)"
    },
    "priority": {
      "type": "string",
      "enum": [
        "critical",
        "high",
        "medium",
        "low"
      ],
      "description": "优先级枚举"
    }
  },
  "properties": {
    "protocol_version": {
      "$ref": "#/$defs/version",
      "description": "MPLP协议版本",
      "const": "1.0.1"
    },
    "timestamp": {
      "$ref": "#/$defs/timestamp",
      "description": "协议消息时间戳"
    },
    "extension_id": {
      "$ref": "#/$defs/uuid",
      "description": "扩展唯一标识符"
    },
    "context_id": {
      "$ref": "#/$defs/uuid",
      "description": "关联的上下文ID"
    },
    "name": {
      "type": "string",
      "pattern": "^[a-zA-Z0-9_-]+$",
      "minLength": 1,
      "maxLength": 64,
      "description": "扩展名称（仅允许字母、数字、下划线和连字符）"
    },
    "display_name": {
      "type": "string",
      "minLength": 1,
      "maxLength": 255,
      "description": "扩展显示名称"
    },
    "description": {
      "type": "string",
      "maxLength": 2000,
      "description": "扩展详细描述"
    },
    "version": {
      "$ref": "#/$defs/version",
      "description": "扩展版本号"
    },
    "extension_type": {
      "type": "string",
      "enum": [
        "plugin",
        "adapter",
        "connector",
        "middleware",
        "hook",
        "transformer"
      ],
      "description": "扩展类型"
    },
    "status": {
      "type": "string",
      "enum": [
        "installed",
        "active",
        "inactive",
        "disabled",
        "error",
        "updating",
        "uninstalling"
      ],
      "description": "扩展状态"
    },
    "compatibility": {
      "type": "object",
      "properties": {
        "mplp_version": {
          "type": "string",
          "description": "兼容的MPLP版本范围"
        },
        "required_modules": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "module": {
                "type": "string",
                "enum": [
                  "context",
                  "plan",
                  "confirm",
                  "trace",
                  "role",
                  "extension"
                ]
              },
              "min_version": {
                "$ref": "#/$defs/version"
              },
              "max_version": {
                "$ref": "#/$defs/version"
              }
            },
            "required": [
              "module"
            ]
          }
        },
        "dependencies": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "extension_id": {
                "$ref": "#/$defs/uuid"
              },
              "name": {
                "type": "string"
              },
              "version_range": {
                "type": "string"
              },
              "optional": {
                "type": "boolean"
              }
            },
            "required": [
              "extension_id",
              "name",
              "version_range"
            ]
          }
        },
        "conflicts": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "extension_id": {
                "$ref": "#/$defs/uuid"
              },
              "name": {
                "type": "string"
              },
              "reason": {
                "type": "string"
              }
            },
            "required": [
              "extension_id",
              "name",
              "reason"
            ]
          }
        }
      },
      "required": [
        "mplp_version"
      ]
    },
    "configuration": {
      "type": "object",
      "properties": {
        "schema": {
          "type": "object",
          "description": "配置参数的JSON Schema定义",
          "additionalProperties": true
        },
        "current_config": {
          "type": "object",
          "description": "当前配置值",
          "additionalProperties": true
        },
        "default_config": {
          "type": "object",
          "description": "默认配置值",
          "additionalProperties": true
        },
        "validation_rules": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "rule": {
                "type": "string"
              },
              "message": {
                "type": "string"
              },
              "severity": {
                "type": "string",
                "enum": [
                  "error",
                  "warning",
                  "info"
                ]
              }
            },
            "required": [
              "rule",
              "message",
              "severity"
            ]
          }
        }
      },
      "required": [
        "schema",
        "current_config"
      ]
    },
    "extension_points": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "point_id": {
            "$ref": "#/$defs/uuid"
          },
          "name": {
            "type": "string"
          },
          "type": {
            "type": "string",
            "enum": [
              "hook",
              "filter",
              "action",
              "api_endpoint",
              "event_listener"
            ]
          },
          "target_module": {
            "type": "string",
            "enum": [
              "context",
              "plan",
              "confirm",
              "trace",
              "role",
              "extension",
              "system"
            ]
          },
          "event_name": {
            "type": "string"
          },
          "execution_order": {
            "type": "integer",
            "minimum": 1
          },
          "enabled": {
            "type": "boolean"
          },
          "handler": {
            "type": "object",
            "properties": {
              "function_name": {
                "type": "string"
              },
              "parameters": {
                "type": "object",
                "additionalProperties": true
              },
              "timeout_ms": {
                "type": "integer",
                "minimum": 100
              },
              "retry_policy": {
                "type": "object",
                "properties": {
                  "max_retries": {
                    "type": "integer",
                    "minimum": 0
                  },
                  "retry_delay_ms": {
                    "type": "integer",
                    "minimum": 100
                  },
                  "backoff_strategy": {
                    "type": "string",
                    "enum": [
                      "fixed",
                      "exponential",
                      "linear"
                    ]
                  }
                }
              }
            },
            "required": [
              "function_name"
            ]
          },
          "conditions": {
            "type": "object",
            "properties": {
              "when": {
                "type": "string",
                "description": "条件表达式"
              },
              "required_permissions": {
                "type": "array",
                "items": {
                  "type": "string"
                }
              },
              "context_filters": {
                "type": "object",
                "additionalProperties": true
              }
            }
          }
        },
        "required": [
          "point_id",
          "name",
          "type",
          "target_module",
          "execution_order",
          "enabled",
          "handler"
        ]
      }
    },
    "api_extensions": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "endpoint_id": {
            "$ref": "#/$defs/uuid"
          },
          "path": {
            "type": "string",
            "pattern": "^/[a-zA-Z0-9/_-]*$"
          },
          "method": {
            "type": "string",
            "enum": [
              "GET",
              "POST",
              "PUT",
              "PATCH",
              "DELETE",
              "OPTIONS",
              "HEAD"
            ]
          },
          "description": {
            "type": "string"
          },
          "handler": {
            "type": "string"
          },
          "middleware": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "authentication_required": {
            "type": "boolean"
          },
          "required_permissions": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "rate_limit": {
            "type": "object",
            "properties": {
              "requests_per_minute": {
                "type": "integer",
                "minimum": 1
              },
              "burst_size": {
                "type": "integer",
                "minimum": 1
              }
            }
          },
          "request_schema": {
            "type": "object",
            "description": "请求体JSON Schema",
            "additionalProperties": true
          },
          "response_schema": {
            "type": "object",
            "description": "响应体JSON Schema",
            "additionalProperties": true
          }
        },
        "required": [
          "endpoint_id",
          "path",
          "method",
          "handler",
          "authentication_required"
        ]
      }
    },
    "event_subscriptions": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "subscription_id": {
            "$ref": "#/$defs/uuid"
          },
          "event_pattern": {
            "type": "string"
          },
          "source_module": {
            "type": "string",
            "enum": [
              "context",
              "plan",
              "confirm",
              "trace",
              "role",
              "extension",
              "system",
              "*"
            ]
          },
          "handler": {
            "type": "string"
          },
          "filter_conditions": {
            "type": "object",
            "additionalProperties": true
          },
          "delivery_guarantees": {
            "type": "string",
            "enum": [
              "at_least_once",
              "at_most_once",
              "exactly_once"
            ]
          },
          "dead_letter_queue": {
            "type": "boolean"
          }
        },
        "required": [
          "subscription_id",
          "event_pattern",
          "source_module",
          "handler",
          "delivery_guarantees"
        ]
      }
    },
    "lifecycle": {
      "type": "object",
      "properties": {
        "install_date": {
          "$ref": "#/$defs/timestamp"
        },
        "last_update": {
          "$ref": "#/$defs/timestamp"
        },
        "activation_count": {
          "type": "integer",
          "minimum": 0
        },
        "error_count": {
          "type": "integer",
          "minimum": 0
        },
        "last_error": {
          "type": "object",
          "properties": {
            "timestamp": {
              "$ref": "#/$defs/timestamp"
            },
            "error_type": {
              "type": "string"
            },
            "message": {
              "type": "string"
            },
            "stack_trace": {
              "type": "string"
            }
          }
        },
        "performance_metrics": {
          "type": "object",
          "properties": {
            "average_execution_time_ms": {
              "type": "number",
              "minimum": 0
            },
            "total_executions": {
              "type": "integer",
              "minimum": 0
            },
            "success_rate": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            },
            "memory_usage_mb": {
              "type": "number",
              "minimum": 0
            }
          }
        },
        "health_check": {
          "type": "object",
          "properties": {
            "endpoint": {
              "type": "string"
            },
            "interval_seconds": {
              "type": "integer",
              "minimum": 1
            },
            "timeout_ms": {
              "type": "integer",
              "minimum": 100
            },
            "failure_threshold": {
              "type": "integer",
              "minimum": 1
            }
          }
        }
      },
      "required": [
        "install_date",
        "activation_count",
        "error_count"
      ]
    },
    "security": {
      "type": "object",
      "properties": {
        "sandbox_enabled": {
          "type": "boolean"
        },
        "resource_limits": {
          "type": "object",
          "properties": {
            "max_memory_mb": {
              "type": "integer",
              "minimum": 1
            },
            "max_cpu_percent": {
              "type": "integer",
              "minimum": 1,
              "maximum": 100
            },
            "max_file_size_mb": {
              "type": "integer",
              "minimum": 1
            },
            "network_access": {
              "type": "boolean"
            },
            "file_system_access": {
              "type": "string",
              "enum": [
                "none",
                "read_only",
                "sandbox",
                "full"
              ]
            }
          }
        },
        "code_signing": {
          "type": "object",
          "properties": {
            "required": {
              "type": "boolean"
            },
            "signature": {
              "type": "string"
            },
            "certificate": {
              "type": "string"
            },
            "timestamp": {
              "$ref": "#/$defs/timestamp"
            }
          }
        },
        "permissions": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "permission": {
                "type": "string"
              },
              "justification": {
                "type": "string"
              },
              "approved": {
                "type": "boolean"
              },
              "approved_by": {
                "type": "string"
              },
              "approval_date": {
                "$ref": "#/$defs/timestamp"
              }
            },
            "required": [
              "permission",
              "justification",
              "approved"
            ]
          }
        }
      },
      "required": [
        "sandbox_enabled",
        "resource_limits"
      ]
    },
    "metadata": {
      "type": "object",
      "properties": {
        "author": {
          "type": "string"
        },
        "organization": {
          "type": "string"
        },
        "license": {
          "type": "string"
        },
        "homepage": {
          "type": "string",
          "format": "uri"
        },
        "repository": {
          "type": "string",
          "format": "uri"
        },
        "documentation": {
          "type": "string",
          "format": "uri"
        },
        "support_contact": {
          "type": "string"
        },
        "keywords": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "categories": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "screenshots": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "url": {
                "type": "string",
                "format": "uri"
              },
              "caption": {
                "type": "string"
              }
            },
            "required": [
              "url"
            ]
          }
        }
      }
    }
  },
  "required": [
    "protocol_version",
    "timestamp",
    "extension_id",
    "context_id",
    "name",
    "type",
    "status",
    "version"
  ],
  "additionalProperties": false
}