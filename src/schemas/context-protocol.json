{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://mplp.dev/schemas/v1.0/context-protocol.json",
  "title": "MPLP Context Protocol v1.0",
  "description": "Context模块协议Schema - 上下文和全局状态管理",
  "type": "object",
  "$defs": {
    "uuid": {
      "type": "string",
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$",
      "description": "UUID v4格式的唯一标识符"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601格式的时间戳"
    },
    "version": {
      "type": "string",
      "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-((?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\\.(?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\\+([0-9a-zA-Z-]+(?:\\.[0-9a-zA-Z-]+)*))?$",
      "description": "语义化版本号 (SemVer)"
    },
    "priority": {
      "type": "string",
      "enum": ["critical", "high", "medium", "low"],
      "description": "优先级枚举"
    }
  },
  "properties": {
    "protocol_version": {
      "$ref": "#/$defs/version",
      "description": "MPLP协议版本",
              "const": "1.0.1"
    },
    "timestamp": {
      "$ref": "#/$defs/timestamp",
      "description": "协议消息时间戳"
    },
    "context_id": {
      "$ref": "#/$defs/uuid",
      "description": "上下文唯一标识符"
    },
    "name": {
      "type": "string",
      "minLength": 1,
      "maxLength": 255,
      "description": "上下文名称"
    },
    "description": {
      "type": "string",
      "maxLength": 1000,
      "description": "上下文描述"
    },
    "status": {
      "type": "string",
      "enum": ["active", "suspended", "completed", "terminated"],
      "description": "上下文状态"
    },
    "lifecycle_stage": {
      "type": "string",
      "enum": ["planning", "executing", "monitoring", "completed"],
      "description": "生命周期阶段"
    },
    "shared_state": {
      "type": "object",
      "properties": {
        "variables": {
          "type": "object",
          "description": "共享变量",
          "additionalProperties": true
        },
        "resources": {
          "type": "object",
          "properties": {
            "allocated": {
              "type": "object",
              "additionalProperties": {
                "type": "object",
                "properties": {
                  "type": { "type": "string" },
                  "amount": { "type": "number" },
                  "unit": { "type": "string" },
                  "status": { "type": "string", "enum": ["available", "allocated", "exhausted"] }
                },
                "required": ["type", "amount", "unit", "status"]
              }
            },
            "requirements": {
              "type": "object",
              "additionalProperties": {
                "type": "object",
                "properties": {
                  "minimum": { "type": "number" },
                  "optimal": { "type": "number" },
                  "maximum": { "type": "number" },
                  "unit": { "type": "string" }
                },
                "required": ["minimum", "unit"]
              }
            }
          },
          "required": ["allocated", "requirements"]
        },
        "dependencies": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "id": { "$ref": "#/$defs/uuid" },
              "type": { "type": "string", "enum": ["context", "plan", "external"] },
              "name": { "type": "string" },
              "version": { "$ref": "#/$defs/version" },
              "status": { "type": "string", "enum": ["pending", "resolved", "failed"] }
            },
            "required": ["id", "type", "name", "status"]
          }
        },
        "goals": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "id": { "$ref": "#/$defs/uuid" },
              "name": { "type": "string" },
              "description": { "type": "string" },
              "priority": { "$ref": "#/$defs/priority" },
              "status": { "type": "string", "enum": ["defined", "active", "achieved", "abandoned"] },
              "success_criteria": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "metric": { "type": "string" },
                    "operator": { "type": "string", "enum": ["eq", "ne", "gt", "gte", "lt", "lte"] },
                    "value": { "type": ["string", "number", "boolean"] },
                    "unit": { "type": "string" }
                  },
                  "required": ["metric", "operator", "value"]
                }
              }
            },
            "required": ["id", "name", "priority", "status"]
          }
        }
      },
      "required": ["variables", "resources", "dependencies", "goals"]
    },
    "access_control": {
      "type": "object",
      "properties": {
        "owner": {
          "type": "object",
          "properties": {
            "user_id": { "type": "string" },
            "role": { "type": "string" }
          },
          "required": ["user_id", "role"]
        },
        "permissions": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "principal": { "type": "string" },
              "principal_type": { "type": "string", "enum": ["user", "role", "group"] },
              "resource": { "type": "string" },
              "actions": {
                "type": "array",
                "items": { "type": "string", "enum": ["read", "write", "execute", "delete", "admin"] }
              },
              "conditions": {
                "type": "object",
                "additionalProperties": true
              }
            },
            "required": ["principal", "principal_type", "resource", "actions"]
          }
        },
        "policies": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "id": { "$ref": "#/$defs/uuid" },
              "name": { "type": "string" },
              "type": { "type": "string", "enum": ["security", "compliance", "operational"] },
              "rules": { "type": "array", "items": { "type": "object" } },
              "enforcement": { "type": "string", "enum": ["strict", "advisory", "disabled"] }
            },
            "required": ["id", "name", "type", "rules", "enforcement"]
          }
        }
      },
      "required": ["owner", "permissions"]
    },
    "configuration": {
      "type": "object",
      "properties": {
        "timeout_settings": {
          "type": "object",
          "properties": {
            "default_timeout": { "type": "integer", "minimum": 1 },
            "max_timeout": { "type": "integer", "minimum": 1 },
            "cleanup_timeout": { "type": "integer", "minimum": 1 }
          },
          "required": ["default_timeout", "max_timeout"]
        },
        "notification_settings": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean" },
            "channels": {
              "type": "array",
              "items": { "type": "string", "enum": ["email", "webhook", "sms", "push"] }
            },
            "events": {
              "type": "array",
              "items": { "type": "string", "enum": ["created", "updated", "completed", "failed", "timeout"] }
            }
          },
          "required": ["enabled"]
        },
        "persistence": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean" },
            "storage_backend": { "type": "string", "enum": ["memory", "database", "file", "redis"] },
            "retention_policy": {
              "type": "object",
              "properties": {
                "duration": { "type": "string" },
                "max_versions": { "type": "integer", "minimum": 1 }
              }
            }
          },
          "required": ["enabled", "storage_backend"]
        }
      },
      "required": ["timeout_settings", "persistence"]
    }
  },
  "required": [
    "protocol_version",
    "timestamp", 
    "context_id", 
    "name", 
    "status", 
    "lifecycle_stage", 
    "shared_state", 
    "access_control",
    "configuration"
  ],
  "additionalProperties": false
}