/**
 * ÁúüÊ≠£ÁöÑ‰∏öÂä°Â∑•‰ΩúÊµÅÈõÜÊàêÊµãËØï
 * @description P0Êû∂ÊûÑ‰øÆÂ§çÈ™åËØÅÔºöÊµãËØïPlan ‚Üí Confirm ‚Üí Trace‰∏öÂä°Êï∞ÊçÆÊµÅËΩ¨
 * @author MPLP Team
 * @version 2.0.0
 * @created 2025-08-05 02:00
 * 
 * ÊµãËØïÁõÆÊ†áÔºö
 * 1. È™åËØÅÁúüÊ≠£ÁöÑ‰∏öÂä°Â∑•‰ΩúÊµÅÊâßË°å
 * 2. È™åËØÅÊ®°ÂùóÈó¥Êï∞ÊçÆ‰º†ÈÄí
 * 3. È™åËØÅPlanËæìÂá∫ ‚Üí ConfirmËæìÂÖ• ‚Üí TraceËæìÂÖ•ÁöÑÊï∞ÊçÆÊµÅËΩ¨
 * 4. È™åËØÅP0Êû∂ÊûÑ‰øÆÂ§çÁöÑÊúâÊïàÊÄß
 */

import { jest } from '@jest/globals';
import { CoreOrchestrator } from '../../src/public/modules/core/orchestrator/core-orchestrator';
import { PlanModuleAdapter } from '../../src/modules/plan/infrastructure/adapters/plan-module.adapter';
import { ConfirmModuleAdapter } from '../../src/modules/confirm/infrastructure/adapters/confirm-module.adapter';
import { TraceModuleAdapter } from '../../src/modules/trace/infrastructure/adapters/trace-module.adapter';

// Core types
import { 
  WorkflowConfiguration,
  WorkflowExecutionResult,
  OrchestratorConfiguration,
  BusinessData,
  UUID
} from '../../src/public/modules/core/types/core.types';

// Module services (Mock)
import { PlanManagementService } from '../../src/modules/plan/application/services/plan-management.service';
import { PlanExecutionService } from '../../src/modules/plan/application/services/plan-execution.service';
import { ConfirmManagementService } from '../../src/modules/confirm/application/services/confirm-management.service';
import { ConfirmFactory } from '../../src/modules/confirm/domain/factories/confirm.factory';
import { ConfirmValidationService } from '../../src/modules/confirm/domain/services/confirm-validation.service';
import { TraceManagementService } from '../../src/modules/trace/application/services/trace-management.service';
import { TraceFactory } from '../../src/modules/trace/domain/factories/trace.factory';
import { TraceAnalysisService } from '../../src/modules/trace/domain/services/trace-analysis.service';

import { TestDataFactory } from '../public/test-utils/test-data-factory';

describe('ÁúüÊ≠£ÁöÑ‰∏öÂä°Â∑•‰ΩúÊµÅÈõÜÊàêÊµãËØï - P0Êû∂ÊûÑ‰øÆÂ§çÈ™åËØÅ', () => {
  let coreOrchestrator: CoreOrchestrator;
  let planAdapter: PlanModuleAdapter;
  let confirmAdapter: ConfirmModuleAdapter;
  let traceAdapter: TraceModuleAdapter;

  // Mock services
  let mockPlanManagementService: jest.Mocked<PlanManagementService>;
  let mockPlanExecutionService: jest.Mocked<PlanExecutionService>;
  let mockConfirmManagementService: jest.Mocked<ConfirmManagementService>;
  let mockConfirmFactory: jest.Mocked<ConfirmFactory>;
  let mockConfirmValidationService: jest.Mocked<ConfirmValidationService>;
  let mockTraceManagementService: jest.Mocked<TraceManagementService>;
  let mockTraceFactory: jest.Mocked<TraceFactory>;
  let mockTraceAnalysisService: jest.Mocked<TraceAnalysisService>;

  beforeEach(async () => {
    // ÂàõÂª∫ÊâÄÊúâMockÊúçÂä°
    mockPlanManagementService = {
      createPlan: jest.fn(),
      getPlan: jest.fn(),
      updatePlan: jest.fn(),
      deletePlan: jest.fn(),
      updatePlanStatus: jest.fn(),
      findPlans: jest.fn(),
      countPlans: jest.fn(),
      isPlanExecutable: jest.fn()
    } as jest.Mocked<PlanManagementService>;

    mockPlanExecutionService = {
      executePlan: jest.fn(),
      pausePlan: jest.fn(),
      resumePlan: jest.fn(),
      cancelPlan: jest.fn(),
      getExecutionStatus: jest.fn(),
      getExecutionHistory: jest.fn()
    } as jest.Mocked<PlanExecutionService>;

    mockConfirmManagementService = {
      createConfirm: jest.fn(),
      getConfirmById: jest.fn(),
      updateConfirmStatus: jest.fn(),
      cancelConfirm: jest.fn(),
      queryConfirms: jest.fn(),
      getPendingConfirms: jest.fn(),
      processExpiredConfirms: jest.fn(),
      getConfirmStatistics: jest.fn(),
      batchUpdateStatus: jest.fn()
    } as jest.Mocked<ConfirmManagementService>;

    mockConfirmFactory = {
      create: jest.fn()
    } as unknown as jest.Mocked<ConfirmFactory>;

    mockConfirmValidationService = {
      validateCreateRequest: jest.fn(),
      validateUpdateRequest: jest.fn(),
      validateStatusTransition: jest.fn()
    } as jest.Mocked<ConfirmValidationService>;

    mockTraceManagementService = {
      createTrace: jest.fn(),
      getTraceById: jest.fn(),
      queryTraces: jest.fn(),
      getErrorTraces: jest.fn(),
      getPerformanceTraces: jest.fn(),
      addCorrelation: jest.fn(),
      updatePerformanceMetrics: jest.fn(),
      setErrorInformation: jest.fn(),
      analyzeTraces: jest.fn(),
      analyzePerformance: jest.fn(),
      getTraceChain: jest.fn(),
      getStatistics: jest.fn(),
      searchTraces: jest.fn(),
      cleanupExpiredTraces: jest.fn(),
      deleteTrace: jest.fn(),
      batchDeleteTraces: jest.fn(),
      detectAndAddCorrelations: jest.fn(),
      recordEvent: jest.fn()
    } as jest.Mocked<TraceManagementService>;

    mockTraceFactory = {
      create: jest.fn()
    } as unknown as jest.Mocked<TraceFactory>;

    mockTraceAnalysisService = {
      analyzeTrace: jest.fn(),
      generateReport: jest.fn(),
      calculateMetrics: jest.fn(),
      detectAnomalies: jest.fn(),
      correlateTraces: jest.fn()
    } as jest.Mocked<TraceAnalysisService>;

    // ÂàõÂª∫ÈÄÇÈÖçÂô®ÂÆû‰æã
    planAdapter = new PlanModuleAdapter(
      mockPlanManagementService,
      mockPlanExecutionService
    );

    confirmAdapter = new ConfirmModuleAdapter(
      mockConfirmManagementService,
      mockConfirmFactory,
      mockConfirmValidationService
    );

    traceAdapter = new TraceModuleAdapter(
      mockTraceManagementService,
      mockTraceFactory,
      mockTraceAnalysisService
    );

    // ÂàùÂßãÂåñÈÄÇÈÖçÂô®
    await planAdapter.initialize();
    await confirmAdapter.initialize();
    await traceAdapter.initialize();

    // ÂàõÂª∫CoreÂçèË∞ÉÂô®ÈÖçÁΩÆ
    const orchestratorConfig: OrchestratorConfiguration = {
      default_workflow: {
        stages: ['plan', 'confirm', 'trace'],
        parallel_execution: false, // ÂÖ≥ÈîÆÔºöÈ°∫Â∫èÊâßË°å
        timeout_ms: 30000,
        retry_policy: {
          max_attempts: 3,
          delay_ms: 1000
        }
      } as WorkflowConfiguration,
      module_timeout_ms: 10000,
      max_concurrent_executions: 5,
      enable_performance_monitoring: true,
      enable_event_logging: true
    };

    // ÂàõÂª∫CoreÂçèË∞ÉÂô®
    coreOrchestrator = new CoreOrchestrator(orchestratorConfig);
    
    // Ê≥®ÂÜåÊ®°ÂùóÈÄÇÈÖçÂô®
    coreOrchestrator.registerModule(planAdapter);
    coreOrchestrator.registerModule(confirmAdapter);
    coreOrchestrator.registerModule(traceAdapter);

    // ÂàùÂßãÂåñCoreÂçèË∞ÉÂô®
    await coreOrchestrator.initialize();
  });

  afterEach(async () => {
    await coreOrchestrator.cleanup();
    await TestDataFactory.Manager.cleanup();
    jest.clearAllMocks();
  });

  describe('P0Êû∂ÊûÑ‰øÆÂ§çÈ™åËØÅÔºöÁúüÊ≠£ÁöÑ‰∏öÂä°Â∑•‰ΩúÊµÅ', () => {
    test('Â∫îËØ•ÊâßË°åÁúüÊ≠£ÁöÑPlan ‚Üí Confirm ‚Üí Trace‰∏öÂä°Â∑•‰ΩúÊµÅ', async () => {
      const contextId = TestDataFactory.Base.generateUUID();

      // ËÆæÁΩÆMockËøîÂõûÂÄº - Ê®°ÊãüÁúüÂÆûÁöÑ‰∏öÂä°Êï∞ÊçÆÊµÅËΩ¨
      const planData = TestDataFactory.Plan.createPlanData({ context_id: contextId });
      const confirmData = TestDataFactory.Confirm.createConfirmData({ context_id: contextId });
      const traceData = TestDataFactory.Trace.createTraceData({ context_id: contextId });

      // PlanÈò∂ÊÆµMock
      mockPlanManagementService.createPlan.mockResolvedValue({
        success: true,
        data: planData
      });

      // ConfirmÈò∂ÊÆµMock
      mockConfirmManagementService.createConfirm.mockResolvedValue({
        success: true,
        data: confirmData
      });

      // TraceÈò∂ÊÆµMock
      mockTraceManagementService.createTrace.mockResolvedValue({
        success: true,
        data: traceData
      });

      mockTraceManagementService.recordEvent.mockResolvedValue({
        success: true,
        data: { event_id: 'test-event-id', recorded_at: new Date().toISOString() }
      });

      // ÊâßË°åÁúüÊ≠£ÁöÑ‰∏öÂä°Â∑•‰ΩúÊµÅ
      const workflowResult: WorkflowExecutionResult = await coreOrchestrator.executeWorkflow(
        contextId as UUID,
        {
          stages: ['plan', 'confirm', 'trace'],
          parallel_execution: false, // Á°Æ‰øùÈ°∫Â∫èÊâßË°å
          timeout_ms: 30000
        }
      );

      // È™åËØÅÂ∑•‰ΩúÊµÅÊâßË°åÁªìÊûú
      expect(workflowResult.execution_id).toBeDefined();
      expect(workflowResult.context_id).toBe(contextId);
      expect(workflowResult.status).toBe('completed');
      expect(workflowResult.stages).toHaveLength(3);

      // È™åËØÅÊâßË°åÈ°∫Â∫è
      expect(workflowResult.stages[0].stage).toBe('plan');
      expect(workflowResult.stages[1].stage).toBe('confirm');
      expect(workflowResult.stages[2].stage).toBe('trace');

      // È™åËØÅÊâÄÊúâÈò∂ÊÆµÈÉΩÊàêÂäü
      workflowResult.stages.forEach(stage => {
        expect(stage.status).toBe('completed');
        expect(stage.result).toBeDefined();
      });

      // ÂÖ≥ÈîÆÈ™åËØÅÔºöÁ°ÆËÆ§ÊúçÂä°Ë∞ÉÁî®È°∫Â∫èÂíåÊï∞ÊçÆ‰º†ÈÄí
      expect(mockPlanManagementService.createPlan).toHaveBeenCalledTimes(1);
      expect(mockConfirmManagementService.createConfirm).toHaveBeenCalledTimes(1);
      expect(mockTraceManagementService.createTrace).toHaveBeenCalledTimes(1);
      expect(mockTraceManagementService.recordEvent).toHaveBeenCalledTimes(2);

      // È™åËØÅÊâßË°åÊó∂Èó¥ÂêàÁêÜ
      expect(workflowResult.total_duration_ms).toBeGreaterThan(0);
      expect(workflowResult.total_duration_ms).toBeLessThan(30000);

      console.log('‚úÖ P0Êû∂ÊûÑ‰øÆÂ§çÈ™åËØÅÊàêÂäüÔºöÁúüÊ≠£ÁöÑ‰∏öÂä°Â∑•‰ΩúÊµÅÊâßË°åÂÆåÊàê');
      console.log(`üìä Â∑•‰ΩúÊµÅÊâßË°åÁªìÊûúÔºö${workflowResult.status}`);
      console.log(`‚è±Ô∏è ÊâßË°åÊó∂Èó¥Ôºö${workflowResult.total_duration_ms}ms`);
      console.log(`üîÑ Èò∂ÊÆµÊï∞ÈáèÔºö${workflowResult.stages.length}`);
    });

    test('Â∫îËØ•Âú®PlanÈò∂ÊÆµÂ§±Ë¥•Êó∂Ê≠£Á°ÆÂÅúÊ≠¢Â∑•‰ΩúÊµÅ', async () => {
      const contextId = TestDataFactory.Base.generateUUID();

      // ËÆæÁΩÆPlanÂ§±Ë¥•
      mockPlanManagementService.createPlan.mockResolvedValue({
        success: false,
        error: 'Plan creation failed'
      });

      // ÊâßË°åÂ∑•‰ΩúÊµÅ
      const workflowResult: WorkflowExecutionResult = await coreOrchestrator.executeWorkflow(
        contextId as UUID,
        {
          stages: ['plan', 'confirm', 'trace'],
          parallel_execution: false
        }
      );

      // È™åËØÅÂ∑•‰ΩúÊµÅÂ§±Ë¥•
      expect(workflowResult.status).toBe('failed');
      expect(workflowResult.stages.length).toBeGreaterThan(0); // Ëá≥Â∞ëÊâßË°å‰∫ÜPlanÈò∂ÊÆµ

      // È™åËØÅPlanË¢´Ë∞ÉÁî®Ôºå‰ΩÜConfirmÂíåTraceÊ≤°ÊúâË¢´Ë∞ÉÁî®
      expect(mockPlanManagementService.createPlan).toHaveBeenCalledTimes(1);
      expect(mockConfirmManagementService.createConfirm).not.toHaveBeenCalled();
      expect(mockTraceManagementService.createTrace).not.toHaveBeenCalled();

      console.log('‚úÖ P0Êû∂ÊûÑ‰øÆÂ§çÈ™åËØÅÊàêÂäüÔºöÂ∑•‰ΩúÊµÅÈîôËØØÂ§ÑÁêÜÊ≠£Á°Æ');
    });
  });
});
